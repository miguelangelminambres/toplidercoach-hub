<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HUB TopLiderCoach</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        
        /* ========== LOGIN ========== */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo h1 {
            font-size: 28px;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .login-logo p {
            color: #6b7280;
            font-size: 14px;
        }
        
        .login-box input {
            width: 100%;
            padding: 14px 18px;
            margin-bottom: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
        }
        
        .login-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-box button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .login-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .login-error {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
            text-align: center;
            font-size: 14px;
        }
        
        /* ========== HEADER ========== */
        .app-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .app-header h1 {
            font-size: 22px;
            font-weight: 700;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .club-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 10px;
        }
        
        .club-badge img {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            object-fit: contain;
            background: white;
        }
        
        .club-badge .club-initial {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        
        .club-badge span {
            font-weight: 500;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-name {
            font-weight: 500;
            opacity: 0.9;
        }
        
        .btn-logout {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-logout:hover {
            background: rgba(255,255,255,0.25);
        }
        
        /* ========== TABS PRINCIPALES ========== */
        .main-tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid #e5e7eb;
            padding: 0 20px;
        }
        
        .main-tab {
            padding: 18px 30px;
            border: none;
            background: none;
            font-size: 15px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .main-tab:hover {
            color: #374151;
            background: #f9fafb;
        }
        
        .main-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .main-tab.planificador.active {
            color: #7c3aed;
            border-bottom-color: #7c3aed;
        }
        
        .main-tab.matchstats.active {
            color: #059669;
            border-bottom-color: #059669;
        }
        
        .main-tab.config.active {
            color: #d97706;
            border-bottom-color: #d97706;
        }
        .main-tab.staff.active {
    color: #dc2626;
    border-bottom-color: #dc2626;
}

/* ========== TU CUERPO TÉCNICO ========== */
.staff-container {
    padding: 30px;
    max-width: 1200px;
    margin: 0 auto;
}

.staff-header {
    text-align: center;
    margin-bottom: 40px;
}

.staff-header h2 {
    font-size: 28px;
    color: #1f2937;
    margin-bottom: 10px;
}

.staff-header p {
    color: #6b7280;
    font-size: 16px;
}

.staff-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
}

.staff-card {
    background: white;
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: all 0.3s;
    cursor: pointer;
    border: 3px solid transparent;
}

.staff-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
}

.staff-card.johan:hover { border-color: #f59e0b; }
.staff-card.valeri:hover { border-color: #3b82f6; }
.staff-card.arrigo:hover { border-color: #10b981; }

.staff-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    margin: 0 auto 20px;
    overflow: hidden;
    border: 4px solid #e5e7eb;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
}

.staff-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.staff-card h3 {
    font-size: 22px;
    color: #1f2937;
    margin-bottom: 5px;
}

.staff-card .rol {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 15px;
}

.staff-card .descripcion {
    font-size: 13px;
    color: #9ca3af;
    line-height: 1.6;
    margin-bottom: 20px;
}

.staff-card .btn-consultar {
    padding: 12px 30px;
    border: none;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    color: white;
}

.staff-card.johan .btn-consultar { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
.staff-card.valeri .btn-consultar { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
.staff-card.arrigo .btn-consultar { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }

.staff-card .btn-consultar:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

/* Chat Modal */
.chat-container {
    display: flex;
    flex-direction: column;
    height: 500px;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f8fafc;
    border-radius: 12px;
    margin-bottom: 15px;
}

.chat-message {
    margin-bottom: 15px;
    display: flex;
    gap: 10px;
}

.chat-message.user {
    flex-direction: row-reverse;
}

.chat-message .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    overflow: hidden;
}

.chat-message .avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.chat-message.user .avatar {
    background: #6b7280;
    color: white;
}

.chat-message.assistant .avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.chat-message .contenido {
    max-width: 75%;
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.5;
}

.chat-message.user .contenido {
    background: #1f2937;
    color: white;
    border-bottom-right-radius: 4px;
}

.chat-message.assistant .contenido {
    background: white;
    color: #1f2937;
    border: 1px solid #e5e7eb;
    border-bottom-left-radius: 4px;
}

.chat-input-container {
    display: flex;
    gap: 10px;
}

.chat-input-container input {
    flex: 1;
    padding: 14px 18px;
    border: 2px solid #e5e7eb;
    border-radius: 25px;
    font-size: 14px;
}

.chat-input-container input:focus {
    outline: none;
    border-color: #667eea;
}

.chat-input-container button {
    padding: 14px 25px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
}

.chat-typing {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 10px 15px;
    color: #9ca3af;
    font-size: 13px;
}

.chat-typing .dots span {
    display: inline-block;
    width: 6px;
    height: 6px;
    background: #9ca3af;
    border-radius: 50%;
    margin: 0 2px;
    animation: typing 1.4s infinite;
}

.chat-typing .dots span:nth-child(2) { animation-delay: 0.2s; }
.chat-typing .dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-5px); }
}
        /* ========== SUB TABS ========== */
        .sub-tabs {
            display: flex;
            background: #f8fafc;
            padding: 10px 20px;
            gap: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .sub-tab {
            padding: 10px 20px;
            border: none;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .sub-tab:hover {
            border-color: #e5e7eb;
        }
        
        .sub-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        /* Colores específicos por módulo */
        .planificador-subtabs .sub-tab.active {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }
        
        .matchstats-subtabs .sub-tab.active {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .config-subtabs .sub-tab.active {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }
        
        /* ========== VISTAS ========== */
        .vista-modulo {
            display: none;
        }
        
        .vista-modulo.active {
            display: block;
        }
        
        .vista-contenido {
            display: none;
            padding: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .vista-contenido.active {
            display: block;
        }
        
        /* ========== HEADERS DE SECCIÓN ========== */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .section-header h2 {
            font-size: 24px;
            color: #1f2937;
        }
        
        /* ========== BOTONES GENERALES ========== */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary.green {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .btn-primary.green:hover {
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
        }
        
        .btn-primary.purple {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-danger {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        
        /* ========== CARDS ========== */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .card-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .card-body {
            padding: 20px;
        }
        
        /* ========== FORMULARIOS ========== */
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* ========== GRIDS ========== */
        .grid-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        /* ========== LOADING & EMPTY ========== */
        .loading {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        
        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .empty-state h3 {
            color: #6b7280;
            margin-bottom: 10px;
        }
        
        /* ========== MODALES ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 20px;
            color: #1f2937;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #9ca3af;
            line-height: 1;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* ========== FILTROS ========== */
        .filtros-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        
        .filtro-grupo {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filtro-grupo label {
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
        }
        
        .filtro-grupo input,
        .filtro-grupo select {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .filtro-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .filtro-btn.active {
            border-color: #667eea;
            background: #f0f0ff;
            color: #667eea;
        }

        /* ========== ESPECÍFICO PLANIFICADOR ========== */
        .planificador-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 350px;
            gap: 20px;
            height: calc(100vh - 200px);
        }
        
        .panel {
            background: white;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
        }
        
        .panel-header h3 {
            font-size: 16px;
            color: #1f2937;
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        /* Biblioteca de ejercicios */
        .ejercicio-card {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            align-items: center;
        }
        
        .ejercicio-card:hover {
            border-color: #7c3aed;
            background: #faf5ff;
        }
        
        .ejercicio-card.selected {
            border-color: #7c3aed;
            background: #f3e8ff;
        }
        
        .ejercicio-card img {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }
        
        .ejercicio-card .info {
            flex: 1;
            min-width: 0;
        }
        
        .ejercicio-card .titulo {
            font-weight: 600;
            font-size: 13px;
            color: #1f2937;
            margin-bottom: 5px;
            line-height: 1.3;
        }
        
        .ejercicio-card .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .ejercicio-card .tag {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            background: #e0e7ff;
            color: #4338ca;
        }
        
        .ejercicio-card .tag.dificultad {
            background: #fef3c7;
            color: #b45309;
        }
        
        .ejercicio-card .btn-agregar {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .ejercicio-card .btn-agregar:hover {
            background: #6d28d9;
            transform: scale(1.05);
        }
        /* Filtros biblioteca */
        .filtros-toggle {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            padding: 12px 16px;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }
        
        .filtros-toggle h4 {
            margin: 0;
            font-size: 13px;
            font-weight: 600;
            color: white;
        }
        
        .filtros-toggle .toggle-icon {
            color: white;
            transition: transform 0.3s;
        }
        
        .filtros-toggle.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        .filtros-biblioteca {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .filtros-biblioteca.collapsed {
            display: none;
        }
        
        .filtros-biblioteca select,
        .filtros-biblioteca input {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            background: white;
        }
        
        .filtros-biblioteca select:focus,
        .filtros-biblioteca input:focus {
            outline: none;
            border-color: #7c3aed;
        }
        
        .filtros-biblioteca .filtros-botones {
            display: flex;
            gap: 10px;
        }
        
        .btn-filtrar {
            flex: 1;
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-limpiar-filtros {
            background: #f1f5f9;
            color: #475569;
            border: 2px solid #e2e8f0;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        /* Toggle info sesion */
        .info-sesion-toggle {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            padding: 12px 16px;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: none;
            width: 100%;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }
        
        .info-sesion-toggle span {
            font-size: 13px;
            font-weight: 600;
            color: white;
        }
        
        .info-sesion-toggle .toggle-icon {
            color: white;
            transition: transform 0.3s;
        }
        
        .info-sesion-toggle.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        .sesion-info-grid {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .sesion-info-grid.collapsed {
            display: none;
        }
        
        .campo-grupo {
            display: flex;
            flex-direction: column;
        }
        
        .campo-grupo.full-width {
            grid-column: span 2;
        }
        
        .campo-grupo label {
            font-size: 12px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 5px;
        }
        
        .campo-grupo input,
        .campo-grupo textarea,
        .campo-grupo select {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .campo-grupo input:focus,
        .campo-grupo textarea:focus,
        .campo-grupo select:focus {
            outline: none;
            border-color: #7c3aed;
        }
        
        .campo-grupo textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .duracion-total-display {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .duracion-total-display .label {
            font-size: 13px;
            font-weight: 500;
        }
        
        .duracion-total-display .tiempo {
            font-size: 18px;
            font-weight: 700;
        }
       /* Selector de jugadores sesion */
        .jugadores-selector {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }
        
        .jugadores-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .jugadores-selector-header h4 {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin: 0;
        }
        
        .jugadores-selector-header .contador {
            font-size: 12px;
            color: #6b7280;
        }
        
        .jugadores-sesion-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
            max-height: 120px;
            overflow-y: auto;
            padding: 8px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .jugador-check {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 6px;
            background: white;
            border-radius: 6px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .jugador-check:hover {
            border-color: #7c3aed;
        }
        
       .jugador-check.selected {
            background: #dcfce7;
            border-color: #22c55e;
        }
        
        .jugador-check.selected .dorsal {
            background: #22c55e;
        }
        
        .jugador-check .dorsal {
            background: #7c3aed;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .jugador-check .nombre {
            font-size: 10px;
            color: #374151;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .btn-seleccionar-todos {
            font-size: 11px;
            padding: 4px 10px;
            background: #e5e7eb;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-seleccionar-todos:hover {
            background: #d1d5db;
        }
        
        .btn-seleccionar-todos:hover {
            background: #d1d5db;
        }
        
        @media (max-width: 768px) {
            .sesion-info-grid {
                grid-template-columns: 1fr;
            }
            
            .campo-grupo.full-width {
                grid-column: span 1;
            }
        }
        /* Sesión */
        .seccion-ejercicios {
            margin-bottom: 20px;
        }
        
        .seccion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            color: white;
            font-weight: 600;
        }
        
        .seccion-header.calentamiento {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }
        
        .seccion-header.principal {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .seccion-header.enfriamiento {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .ejercicio-en-sesion {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ejercicio-en-sesion .nombre {
            font-weight: 500;
            font-size: 14px;
        }
        
        .ejercicio-en-sesion .duracion {
            font-size: 12px;
            color: #6b7280;
        }
        
        .ejercicio-en-sesion button {
            background: #fee2e2;
            border: none;
            color: #dc2626;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* Detalles ejercicio */
        .detalle-ejercicio {
            text-align: center;
            color: #9ca3af;
            padding: 40px 20px;
        }
        
        .detalle-ejercicio.active {
            text-align: left;
            color: #1f2937;
        }
        
        .detalle-ejercicio img {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .detalle-ejercicio h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .detalle-ejercicio p {
            font-size: 14px;
            color: #4b5563;
            line-height: 1.6;
        }
        
        .detalle-seccion {
            margin-top: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #7c3aed;
        }
        
        .detalle-seccion h4 {
            font-size: 14px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .detalle-seccion p {
            font-size: 13px;
            color: #4b5563;
            line-height: 1.6;
            margin: 0;
            white-space: pre-wrap;
        }
        
        .btn-ver-completo {
            display: block;
            text-align: center;
            background: #7c3aed;
            color: white;
            padding: 12px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 15px;
        }
        
        .btn-ver-completo:hover {
            background: #6d28d9;
        }

        /* ========== ESPECÍFICO MATCHSTATS ========== */
        .partido-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.2s;
        }
        
        .partido-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .partido-card-header {
            padding: 15px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .partido-fecha {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 5px;
        }
        
        .partido-competicion {
            font-size: 12px;
            background: #e0f2fe;
            color: #0369a1;
            padding: 3px 10px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .partido-card-body {
            padding: 20px;
        }
        
        .partido-equipos {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .equipo {
            text-align: center;
            flex: 1;
        }
        
        .equipo-nombre {
            font-weight: 600;
            color: #1f2937;
            font-size: 14px;
        }
        
        .equipo-tipo {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 3px;
        }
        
        .partido-resultado {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            padding: 0 15px;
        }
        
        .partido-resultado.pendiente {
            font-size: 14px;
            color: #9ca3af;
            font-weight: 500;
        }
        
        .resultado-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .resultado-badge.victoria { background: #d1fae5; color: #059669; }
        .resultado-badge.empate { background: #fef3c7; color: #d97706; }
        .resultado-badge.derrota { background: #fee2e2; color: #dc2626; }
        .resultado-badge.pendiente { background: #e5e7eb; color: #6b7280; }
        
        .partido-card-footer {
            padding: 15px 20px;
            background: #f8fafc;
            display: flex;
            gap: 10px;
        }
        
        .partido-card-footer button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }
        
        .btn-ver { background: #e0f2fe; color: #0369a1; }
        .btn-stats { background: #fef3c7; color: #d97706; }
        .btn-pdf { background: #f3e8ff; color: #9333ea; }
        .btn-eliminar { background: #fee2e2; color: #dc2626; }
        
        /* Stats resumen */
        .stats-resumen {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .stat-card .valor {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .stat-card .label {
            font-size: 13px;
            color: #6b7280;
            margin-top: 5px;
        }
        
        .stat-card.victoria { border-left: 4px solid #10b981; }
        .stat-card.empate { border-left: 4px solid #f59e0b; }
        .stat-card.derrota { border-left: 4px solid #ef4444; }
        
        /* Tabla stats */
        .stats-tabla {
            width: 100%;
            border-collapse: collapse;
        }
        
        .stats-tabla th {
            background: #f8fafc;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #64748b;
            font-size: 13px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .stats-tabla td {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f5f9;
            color: #1f2937;
        }
        
        .stats-tabla tr:hover {
            background: #f8fafc;
        }
        
        .jugador-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .jugador-mini-foto {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            overflow: hidden;
        }
        
        .jugador-mini-foto img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ========== ESPECÍFICO MI CLUB ========== */
        .config-club-content {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .escudo-section {
            text-align: center;
        }
        
        .escudo-upload {
            width: 150px;
            height: 150px;
            border: 3px dashed #d1d5db;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: #f9fafb;
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .escudo-upload:hover {
            border-color: #667eea;
        }
        
        .escudo-upload .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .escudo-upload span {
            color: #6b7280;
            font-size: 13px;
        }
        
        .escudo-upload img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .escudo-hint {
            margin-top: 10px;
            font-size: 12px;
            color: #9ca3af;
        }
        
        .club-form {
            flex: 1;
            min-width: 280px;
        }
        
        /* Temporadas */
        .temporadas-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .temporada-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }
        
        .temporada-card.active {
            border-color: #10b981;
            background: #ecfdf5;
        }
        
        .temporada-info h4 {
            font-size: 16px;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .temporada-info p {
            font-size: 12px;
            color: #6b7280;
            margin: 0;
        }
        
        .temporada-badge {
            background: #10b981;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .temporada-actions button {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn-activar {
            background: #d1fae5;
            color: #059669;
        }
        
        .nueva-temporada-form {
            background: #f0fdf4;
            border: 2px dashed #10b981;
            border-radius: 12px;
            padding: 20px;
        }
        
        .nueva-temporada-form h4 {
            color: #059669;
            margin-bottom: 15px;
        }
        
        /* Plantilla */
        .plantilla-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .plantilla-contador {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .plantilla-contador.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .plantilla-contador.full {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .jugadores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .jugador-card {
            background: #f9fafb;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            gap: 12px;
            align-items: center;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
        }
        
        .jugador-card:hover {
            border-color: #667eea;
        }
        
        .jugador-foto {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: 700;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .jugador-foto img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .jugador-info {
            flex: 1;
            min-width: 0;
        }
        
        .jugador-info h4 {
            color: #1f2937;
            margin-bottom: 2px;
            font-size: 14px;
        }
        
        .jugador-info p {
            font-size: 12px;
            color: #6b7280;
            margin: 0;
        }
        
        .jugador-dorsal {
            background: #1f2937;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 13px;
        }
        
        .jugador-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            margin-top: 3px;
            display: inline-block;
        }
        
        .jugador-status.available { background: #d1fae5; color: #059669; }
        .jugador-status.injured { background: #fee2e2; color: #dc2626; }
        .jugador-status.suspended { background: #fef3c7; color: #d97706; }
        
        .jugador-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .jugador-actions button {
            padding: 5px 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .jugador-actions .btn-edit { background: #e5e7eb; color: #374151; }
        .jugador-actions .btn-delete { background: #fee2e2; color: #dc2626; }
        
        .add-jugador-card {
            background: #f0f0ff;
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            min-height: 100px;
        }
        
        .add-jugador-card:hover {
            background: #e8e8ff;
        }
        
        .add-jugador-card .icon {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .add-jugador-card span {
            color: #667eea;
            font-weight: 600;
        }

        /* ========== CALENDARIO ========== */
      .calendario-container {
            background: white;
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow-x: auto;
        }
        
        .calendario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .calendario-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .calendario-nav button {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .mes-actual {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            min-width: 180px;
            text-align: center;
        }
        
    .calendario-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(40px, 1fr));
            gap: 2px;
            min-width: 320px;
        }
        
       .calendario-dia-header {
            text-align: center;
            font-weight: 600;
            color: #6b7280;
            padding: 5px 2px;
            font-size: 11px;
        }
        
       .calendario-dia {
            min-height: 60px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 4px;
            background: white;
            font-size: 11px;
        }
        
        .calendario-dia.otro-mes {
            background: #f9fafb;
            opacity: 0.5;
        }
        
        .calendario-dia.hoy {
            border-color: #667eea;
            background: #f0f0ff;
        }
        
        .calendario-dia .numero {
            font-weight: 600;
            font-size: 14px;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .calendario-evento {
            font-size: 11px;
            padding: 3px 6px;
            border-radius: 4px;
            margin-bottom: 3px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .calendario-evento.sesion {
            background: #f3e8ff;
            color: #7c3aed;
        }
        
        .calendario-evento.partido {
            background: #d1fae5;
            color: #059669;
        }

        /* ========== MIS SESIONES ========== */
        .sesion-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .sesion-card-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .sesion-card-header h3 {
            font-size: 18px;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .sesion-card-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #6b7280;
        }
        
        .sesion-card-resumen {
            display: flex;
            padding: 15px 20px;
            gap: 15px;
        }
        
        .seccion-resumen {
            flex: 1;
            text-align: center;
            padding: 15px;
            border-radius: 12px;
        }
        
        .seccion-resumen.calentamiento {
            background: #fff7ed;
            color: #ea580c;
        }
        
        .seccion-resumen.principal {
            background: #eff6ff;
            color: #2563eb;
        }
        
        .seccion-resumen.enfriamiento {
            background: #ecfdf5;
            color: #059669;
        }
        
        .seccion-resumen strong {
            font-size: 24px;
            display: block;
        }
        
        .sesion-card-actions {
            padding: 15px 20px;
            background: #f8fafc;
            display: flex;
            gap: 10px;
        }
        
        .sesion-card-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }
        
        .btn-cargar { background: #3b82f6; color: white; }
        .btn-pdf-sesion { background: #8b5cf6; color: white; }
        .btn-eliminar-sesion { background: #fee2e2; color: #dc2626; }

        /* ========== CONVOCATORIA ========== */
        .convocatoria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .jugador-check {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .jugador-check:hover {
            background: #f1f5f9;
        }
        
        .jugador-check.selected {
            background: #ecfdf5;
            border-color: #10b981;
        }
        
        .jugador-check input {
            width: 18px;
            height: 18px;
        }
        
        .jugador-check-info .nombre {
            font-weight: 600;
            font-size: 14px;
        }
        
        .jugador-check-info .posicion {
            font-size: 12px;
            color: #6b7280;
        }
        
        .jugador-check .dorsal {
            background: #1f2937;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            margin-left: auto;
        }
/* ========== MODAL PARTIDO AMPLIADO ========== */
        .modal-large {
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .seccion-modal {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .seccion-modal:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .seccion-titulo {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
        }
        
        .seccion-titulo-con-contador {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .seccion-titulo-con-contador .seccion-titulo {
            margin-bottom: 0;
        }
        
        .contador-jugadores {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 10px;
            border-radius: 12px;
        }
        
        .hint-text {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 10px;
        }
        
        .alineacion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }
        
        .jugador-titular {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8fafc;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
        }
        
        .jugador-titular:hover {
            border-color: #3b82f6;
        }
        
        .jugador-titular.es-titular {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        
        .jugador-titular .dorsal {
            background: #1f2937;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 11px;
        }
        
        .jugador-titular.es-titular .dorsal {
            background: #3b82f6;
        }
        
        .jugador-titular .nombre {
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .modal-footer-partido {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .footer-izq, .footer-der {
            display: flex;
            gap: 10px;
        }
        
        @media (max-width: 600px) {
            .modal-footer-partido {
                flex-direction: column;
            }
            .footer-izq, .footer-der {
                width: 100%;
                justify-content: center;
            }
        }
        /* ========== STATS JUGADORES PARTIDO ========== */
        .stats-jugadores-grid .jugador-stats-row {
            display: grid;
            grid-template-columns: 2fr repeat(5, 1fr);
            gap: 10px;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 8px;
        }
        
        .jugador-stats-row .nombre {
            font-weight: 600;
            font-size: 14px;
        }
        
        .jugador-stats-row input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
        }
        
        .stats-labels {
            display: grid;
            grid-template-columns: 2fr repeat(5, 1fr);
            gap: 10px;
            padding: 0 12px;
            margin-bottom: 10px;
        }
        
        .stats-labels span {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-align: center;
        }
        
        .stats-labels span:first-child {
            text-align: left;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 1200px) {
            .planificador-layout {
                grid-template-columns: 1fr 1fr;
                height: auto;
            }
            
            .planificador-layout .panel:last-child {
                grid-column: span 2;
            }
        }
        
        @media (max-width: 768px) {
            .main-tabs {
                padding: 0 10px;
                overflow-x: auto;
            }
            
            .main-tab {
                padding: 14px 18px;
                font-size: 14px;
                white-space: nowrap;
            }
            
            .sub-tabs {
                overflow-x: auto;
                padding: 10px;
            }
            
            .planificador-layout {
                grid-template-columns: 1fr;
            }
            
            .planificador-layout .panel:last-child {
                grid-column: span 1;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .grid-cards {
                grid-template-columns: 1fr;
            }
            
            .config-club-content {
                flex-direction: column;
                align-items: center;
            }
            
            .header-right {
                flex-wrap: wrap;
            }
            
            .club-badge {
                display: none;
            }
            
            .stats-resumen {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .jugador-stats-row {
                grid-template-columns: 1fr repeat(3, 1fr) !important;
            }
            
            .stats-labels {
                grid-template-columns: 1fr repeat(3, 1fr) !important;
            }
        }
    </style>
</head>
<body>
    <!-- ==================== LOGIN ==================== -->
    <div id="login-container" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <h1>HUB TopLiderCoach</h1>
                <p>Plataforma integral para entrenadores</p>
            </div>
            <div id="login-error" class="login-error"></div>
            <input type="text" id="username" placeholder="Usuario o email">
            <input type="password" id="password" placeholder="Contrasena">
            <button onclick="login()">Iniciar Sesion</button>
        </div>
    </div>
    
    <!-- ==================== APP ==================== -->
    <div id="app-container" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <h1>HUB TopLiderCoach</h1>
            <div class="header-right">
                <div class="club-badge" id="club-badge">
                    <div class="club-initial" id="club-initial">?</div>
                    <span id="club-nombre-header">Mi Club</span>
                </div>
                <div class="user-info">
                    <span class="user-name" id="user-name"></span>
                    <button class="btn-logout" onclick="logout()">Salir</button>
                </div>
            </div>
        </header>
        
       <!-- Tabs Principales -->
<div class="main-tabs">
    <button class="main-tab planificador active" onclick="cambiarModulo('planificador', this)">
        Planificador
    </button>
    <button class="main-tab matchstats" onclick="cambiarModulo('matchstats', this)">
        MatchStats
    </button>
    <button class="main-tab staff" onclick="cambiarModulo('staff', this)">
        Tu Cuerpo Técnico
    </button>
    <button class="main-tab config" onclick="cambiarModulo('config', this)">
        Mi Club
    </button>
</div>
        
        <!-- ==================== MODULO: PLANIFICADOR ==================== -->
        <div id="modulo-planificador" class="vista-modulo active">
            <div class="sub-tabs planificador-subtabs">
                <button class="sub-tab active" onclick="cambiarSubTab('planificador', 'crear', this)">Crear Sesion</button>
                <button class="sub-tab" onclick="cambiarSubTab('planificador', 'mis-sesiones', this)">Mis Sesiones</button>
                <button class="sub-tab" onclick="cambiarSubTab('planificador', 'calendario', this)">Calendario</button>
            </div>
            
            <!-- Sub: Crear Sesión -->
            <div id="planificador-crear" class="vista-contenido active">
                <div class="section-header">
                    <h2>Crear Nueva Sesion</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-secondary" onclick="limpiarSesion()">Nueva Sesion</button>
                        <button class="btn-primary purple" onclick="guardarSesion()">Guardar Sesion</button>
                    </div>
                </div>
                
                <!-- Info de la sesión -->
               <!-- Info de la sesión -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-body">
                        <!-- Toggle Info General -->
                        <button class="info-sesion-toggle" onclick="toggleInfoSesion()">
                            <span>Informacion de la Sesion</span>
                            <span class="toggle-icon">▼</span>
                        </button>
                        
                        <!-- Campos Info General -->
                        <div class="sesion-info-grid" id="sesion-info-grid">
                            <div class="campo-grupo full-width">
                                <label>Nombre de la Sesion *</label>
                                <input type="text" id="sesion-nombre" placeholder="Ej: Posesion y finalizacion">
                            </div>
                            
                            <div class="campo-grupo">
                                <label>Fecha</label>
                                <input type="date" id="sesion-fecha">
                            </div>
                            
                            <div class="campo-grupo">
                                <label>Hora de Inicio</label>
                                <input type="time" id="sesion-hora">
                            </div>
                            
                            <div class="campo-grupo">
                                <label>Microciclo</label>
                                <input type="text" id="sesion-microciclo" placeholder="Ej: M1, M2...">
                            </div>
                            
                            <div class="campo-grupo">
                                <label>MD (Match Day)</label>
                                <input type="text" id="sesion-md" placeholder="Ej: MD-2, MD+1...">
                            </div>
                            
                            <div class="campo-grupo">
                                <label>Num Jugadores</label>
                                <input type="number" id="sesion-jugadores" placeholder="Ej: 20" min="1">
                            </div>
                            
                            <div class="campo-grupo">
                                <label>Equipo / Categoria</label>
                                <input type="text" id="sesion-equipo" placeholder="Ej: Juvenil A">
                            </div>
                            
                            <div class="campo-grupo full-width">
                                <label>Objetivo de la Sesion</label>
                                <textarea id="sesion-objetivo" placeholder="Ej: Mejorar la presion alta y transiciones"></textarea>
                            </div>
                            
                            <div class="campo-grupo full-width">
                                <label>Material Necesario</label>
                                <textarea id="sesion-material" placeholder="Ej: 20 conos, 10 petos, 2 porterias..."></textarea>
                            </div>
                            
                            <div class="campo-grupo full-width">
                                <label>Notas Generales</label>
                                <textarea id="sesion-notas" placeholder="Observaciones, condiciones climaticas, etc."></textarea>
                            </div>
                        </div>
                        <!-- Selector de Jugadores -->
                        <div class="jugadores-selector">
                            <div class="jugadores-selector-header">
                                <h4>Jugadores aptos para entrenar</h4>
                                <div>
                                    <span class="contador" id="contador-jugadores">0 seleccionados</span>
                                    <button type="button" class="btn-seleccionar-todos" onclick="toggleTodosJugadores()">Todos</button>
                                </div>
                            </div>
                            <div class="jugadores-sesion-grid" id="jugadores-sesion-grid">                                <p style="color:#9ca3af;font-size:12px;grid-column:1/-1;text-align:center;">Cargando jugadores...</p>
                            </div>
                        </div>
                        <!-- Duracion Total -->
                        <div class="duracion-total-display">
                            <span class="label">Duracion Total:</span>
                            <span class="tiempo" id="duracion-total">0 min</span>
                        </div>
                    </div>
                </div>
                
                <!-- Layout del planificador -->
                <div class="planificador-layout">
                  <!-- Panel Biblioteca -->
                    <div class="panel">
                        <div class="panel-header">
                            <h3>Biblioteca de Ejercicios</h3>
                        </div>
                        <div class="panel-content">
                            <!-- Toggle Filtros -->
                       <!-- Toggle Filtros -->
                            <div class="filtros-toggle collapsed" onclick="toggleFiltros()" id="filtros-toggle">
                                <h4>Filtros Avanzados</h4>
                                <span class="toggle-icon">▼</span>
                            </div>
                            
                            <!-- Filtros (colapsados por defecto) -->
                            <div class="filtros-biblioteca collapsed" id="filtros-biblioteca">
                                <input type="text" id="filtro-buscar" placeholder="Buscar por nombre...">
                                <select id="filtro-entrenador">
                                    <option value="">Entrenador</option>
                                </select>
                                <select id="filtro-equipo">
                                    <option value="">Equipo</option>
                                </select>
                                <select id="filtro-tema">
                                    <option value="">Tema</option>
                                </select>
                                <select id="filtro-dificultad">
                                    <option value="">Dificultad</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                                <div class="filtros-botones">
                                    <button class="btn-filtrar" onclick="cargarEjercicios(1)">Filtrar</button>
                                    <button class="btn-limpiar-filtros" onclick="limpiarFiltros()">Limpiar</button>
                                </div>
                            </div>
                            <div id="lista-ejercicios">
                                <div class="loading">Cargando ejercicios...</div>
                            </div>
                            <div id="paginacion-ejercicios" style="text-align: center; margin-top: 15px;"></div>
                        </div>
                    </div>
                    
                    <!-- Panel Sesión -->
                    <div class="panel">
                        <div class="panel-header">
                            <h3>Mi Sesion</h3>
                        </div>
                        <div class="panel-content">
                            <!-- Calentamiento -->
                            <div class="seccion-ejercicios">
                                <div class="seccion-header calentamiento">
                                    <span>Calentamiento</span>
                                    <span id="tiempo-calentamiento">0 min</span>
                                </div>
                                <div id="lista-calentamiento"></div>
                            </div>
                            
                            <!-- Principal -->
                            <div class="seccion-ejercicios">
                                <div class="seccion-header principal">
                                    <span>Parte Principal</span>
                                    <span id="tiempo-principal">0 min</span>
                                </div>
                                <div id="lista-principal"></div>
                            </div>
                            
                            <!-- Enfriamiento -->
                            <div class="seccion-ejercicios">
                                <div class="seccion-header enfriamiento">
                                    <span>Enfriamiento</span>
                                    <span id="tiempo-enfriamiento">0 min</span>
                                </div>
                                <div id="lista-enfriamiento"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Panel Detalles -->
                    <div class="panel">
                        <div class="panel-header">
                            <h3>Detalles</h3>
                        </div>
                        <div class="panel-content">
                            <div id="detalle-ejercicio" class="detalle-ejercicio">
                                <p>Selecciona un ejercicio para ver sus detalles</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sub: Mis Sesiones -->
            <div id="planificador-mis-sesiones" class="vista-contenido">
                <div class="section-header">
                    <h2>Mis Sesiones Guardadas</h2>
                    <button class="btn-secondary" onclick="cargarMisSesiones()">Actualizar</button>
                </div>
                
                <div class="filtros-bar">
                    <div class="filtro-grupo">
                        <label>Desde:</label>
                        <input type="date" id="filtro-sesion-desde">
                    </div>
                    <div class="filtro-grupo">
                        <label>Hasta:</label>
                        <input type="date" id="filtro-sesion-hasta">
                    </div>
                    <button class="btn-primary" onclick="cargarMisSesiones()">Filtrar</button>
                    <button class="btn-secondary" onclick="limpiarFiltroSesiones()">Limpiar</button>
                </div>
                
                <div id="lista-mis-sesiones" class="grid-cards">
                    <div class="loading">Cargando sesiones...</div>
                </div>
            </div>
            
            <!-- Sub: Calendario -->
            <div id="planificador-calendario" class="vista-contenido">
                <div class="calendario-container">
                    <div class="calendario-header">
                        <h2>Calendario de Sesiones</h2>
                        <div class="calendario-nav">
                            <button onclick="mesAnteriorSesiones()">Anterior</button>
                            <span class="mes-actual" id="mes-actual-sesiones">Diciembre 2025</span>
                            <button onclick="mesSiguienteSesiones()">Siguiente</button>
                        </div>
                    </div>
                    <div class="calendario-grid" id="calendario-sesiones">
                        <!-- Se genera dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== MODULO: MATCHSTATS ==================== -->
        <div id="modulo-matchstats" class="vista-modulo">
            <div class="sub-tabs matchstats-subtabs">
                <button class="sub-tab active" onclick="cambiarSubTab('matchstats', 'partidos', this)">Partidos</button>
                <button class="sub-tab" onclick="cambiarSubTab('matchstats', 'estadisticas', this)">Estadisticas</button>
            </div>
            
            <!-- Sub: Partidos -->
            <div id="matchstats-partidos" class="vista-contenido active">
                <div class="section-header">
                    <h2>Partidos</h2>
                    <button class="btn-primary green" onclick="abrirModalPartido()">+ Nuevo Partido</button>
                </div>
                
                <div class="filtros-bar">
                    <button class="filtro-btn active" onclick="filtrarPartidos('todos', this)">Todos</button>
                    <button class="filtro-btn" onclick="filtrarPartidos('proximos', this)">Proximos</button>
                    <button class="filtro-btn" onclick="filtrarPartidos('jugados', this)">Jugados</button>
                </div>
                
                <div id="lista-partidos" class="grid-cards">
                    <div class="loading">Cargando partidos...</div>
                </div>
            </div>
            
            <!-- Sub: Estadísticas -->
            <div id="matchstats-estadisticas" class="vista-contenido">
                <div class="section-header">
                    <h2>Estadisticas de Temporada</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="stats-temporada" onchange="cargarEstadisticas()"></select>
                        <button class="btn-primary" onclick="exportarEstadisticasPDF()">Exportar PDF</button>
                    </div>
                </div>
                
                <div class="stats-resumen" id="stats-resumen">
                    <!-- Se genera dinámicamente -->
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3>Estadisticas por Jugador</h3>
                    </div>
                    <div class="card-body" style="overflow-x: auto;">
                        <table class="stats-tabla">
                            <thead>
                                <tr>
                                    <th>Jugador</th>
                                    <th>PJ</th>
                                    <th>Min</th>
                                    <th>Goles</th>
                                    <th>Asist.</th>
                                    <th>TA</th>
                                    <th>TR</th>
                                </tr>
                            </thead>
                            <tbody id="stats-tabla-body">
                                <!-- Se genera dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
<!-- ==================== MODULO: TU CUERPO TÉCNICO ==================== -->
<div id="modulo-staff" class="vista-modulo">
    <div class="staff-container">
        <div class="staff-header">
            <h2>🏆 Tu Cuerpo Técnico</h2>
            <p>Tres expertos con IA para ayudarte en tu día a día como entrenador</p>
        </div>
        
        <div class="staff-grid">
            <!-- Johan - Planificador -->
            <div class="staff-card johan" onclick="abrirChatStaff('johan')">
                <div class="staff-avatar">
                    <img src="https://toplidercoach.com/wp-content/uploads/2025/12/captura-de-pantalla-2025-12-11-214833.png" alt="Johan">
                </div>
                <h3>Johan</h3>
                <p class="rol">Tu Planificador de Sesiones</p>
                <p class="descripcion">Experto en diseñar sesiones de entrenamiento personalizadas. Cuéntale tus objetivos, tiempo disponible y número de jugadores, y te creará la sesión perfecta.</p>
                <button class="btn-consultar">Consultar a Johan</button>
            </div>
            
            <!-- Valeri - Analista -->
            <div class="staff-card valeri" onclick="abrirChatStaff('valeri')">
                <div class="staff-avatar">
                    <img src="https://toplidercoach.com/wp-content/uploads/2025/12/captura-de-pantalla-2025-12-11-214736.png" alt="Valeri">
                </div>
                <h3>Valeri</h3>
                <p class="rol">Tu Analista de Rendimiento</p>
                <p class="descripcion">Especialista en análisis de datos y estadísticas. Analiza el rendimiento de tus jugadores, compara métricas y detecta patrones para mejorar.</p>
                <button class="btn-consultar">Consultar a Valeri</button>
            </div>
            
            <!-- Arrigo - Táctico -->
            <div class="staff-card arrigo" onclick="abrirChatStaff('arrigo')">
                <div class="staff-avatar">
                    <img src="https://toplidercoach.com/wp-content/uploads/2025/12/captura-de-pantalla-2025-12-11-214756.png" alt="Arrigo">
                </div>
                <h3>Arrigo</h3>
                <p class="rol">Tu Entrenador Táctico</p>
                <p class="descripcion">Maestro de la táctica y la estrategia. Pregúntale sobre sistemas de juego, ejercicios específicos para mejorar aspectos tácticos de tu equipo.</p>
                <button class="btn-consultar">Consultar a Arrigo</button>
            </div>
        </div>
    </div>
</div>
        <!-- ==================== MODULO: MI CLUB ==================== -->
        <div id="modulo-config" class="vista-modulo">
            <div class="sub-tabs config-subtabs">
                <button class="sub-tab active" onclick="cambiarSubTab('config', 'datos', this)">Datos del Club</button>
                <button class="sub-tab" onclick="cambiarSubTab('config', 'temporadas', this)">Temporadas</button>
                <button class="sub-tab" onclick="cambiarSubTab('config', 'plantilla', this)">Plantilla</button>
            </div>
            
            <!-- Sub: Datos del Club -->
            <div id="config-datos" class="vista-contenido active">
                <div class="card" style="max-width: 800px;">
                    <div class="card-header">
                        <h3>Datos del Club</h3>
                    </div>
                    <div class="card-body">
                        <div class="config-club-content">
                            <div class="escudo-section">
                                <div class="escudo-upload" onclick="document.getElementById('escudo-input').click()">
                                    <img id="escudo-preview" src="" alt="" style="display: none;">
                                    <div id="escudo-placeholder">
                                        <div class="icon">+</div>
                                        <span>Subir escudo</span>
                                    </div>
                                </div>
                                <input type="file" id="escudo-input" accept="image/*" style="display: none;" onchange="previsualizarEscudo(event)">
                                <p class="escudo-hint">JPG, PNG (max 2MB)</p>
                            </div>
                            
                            <div class="club-form">
                                <div class="form-group">
                                    <label>Nombre del Club *</label>
                                    <input type="text" id="club-nombre" placeholder="Ej: CD Villareal">
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Pais</label>
                                        <select id="club-pais">
                                            <option value="Espana">Espana</option>
                                            <option value="Mexico">Mexico</option>
                                            <option value="Argentina">Argentina</option>
                                            <option value="Colombia">Colombia</option>
                                            <option value="Chile">Chile</option>
                                            <option value="Peru">Peru</option>
                                            <option value="Otro">Otro</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Formato de Equipo</label>
                                        <select id="club-formato">
                                            <option value="11">Futbol 11</option>
                                            <option value="8">Futbol 8</option>
                                            <option value="7">Futbol 7</option>
                                            <option value="5">Futbol Sala</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button class="btn-primary" onclick="guardarClub()">Guardar Cambios</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sub: Temporadas -->
            <div id="config-temporadas" class="vista-contenido">
                <div class="card" style="max-width: 800px;">
                    <div class="card-header">
                        <h3>Temporadas</h3>
                    </div>
                    <div class="card-body">
                        <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 15px; border-radius: 0 10px 10px 0; margin-bottom: 20px;">
                            <strong>Como funcionan las temporadas</strong>
                            <p style="margin: 5px 0 0; font-size: 14px; color: #065f46;">Cada temporada tiene su propia plantilla (max 30 jugadores). Las sesiones, partidos y estadisticas se asocian a la temporada activa.</p>
                        </div>
                        
                        <div id="lista-temporadas" class="temporadas-grid">
                            <div class="loading">Cargando temporadas...</div>
                        </div>
                        
                        <div class="nueva-temporada-form">
                            <h4>+ Crear Nueva Temporada</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nombre</label>
                                    <input type="text" id="nueva-temp-nombre" placeholder="2026/2027">
                                </div>
                                <div class="form-group">
                                    <label>Fecha Inicio</label>
                                    <input type="date" id="nueva-temp-inicio">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Fecha Fin</label>
                                    <input type="date" id="nueva-temp-fin">
                                </div>
                                <div class="form-group" style="display: flex; align-items: flex-end;">
                                    <button class="btn-primary green" style="width: 100%;" onclick="crearTemporada()">Crear Temporada</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sub: Plantilla -->
            <div id="config-plantilla" class="vista-contenido">
                <div class="section-header">
                    <div class="plantilla-header" style="width: 100%;">
                        <div class="filtro-grupo">
                            <label>Temporada:</label>
                            <select id="plantilla-temporada" onchange="cargarPlantilla()"></select>
                        </div>
                        <div id="plantilla-contador" class="plantilla-contador">0 / 30 jugadores</div>
                    </div>
                </div>
                
                <div id="lista-jugadores" class="jugadores-grid">
                    <div class="loading">Cargando jugadores...</div>
                </div>
            </div>
        </div>
    </div>
    
   <!-- ==================== MODAL: NUEVO PARTIDO ==================== -->
    <div id="modal-partido" class="modal-overlay" style="display: none;" onclick="cerrarModalPartido(event)">
        <div class="modal-content modal-large" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modal-partido-titulo">Nuevo Partido</h3>
                <button class="modal-close" onclick="cerrarModalPartido()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="partido-id" value="">
                
                <!-- DATOS DEL PARTIDO -->
                <div class="seccion-modal">
                    <h4 class="seccion-titulo">Datos del Partido</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Rival *</label>
                            <input type="text" id="partido-rival" placeholder="Nombre del equipo rival">
                        </div>
                        <div class="form-group">
                            <label>Competicion</label>
                            <input type="text" id="partido-competicion" placeholder="Liga, Copa, Amistoso...">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha *</label>
                            <input type="date" id="partido-fecha">
                        </div>
                        <div class="form-group">
                            <label>Hora partido</label>
                            <input type="time" id="partido-hora">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Local/Visitante</label>
                            <select id="partido-localidad">
                                <option value="home">Local</option>
                                <option value="away">Visitante</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Estadio/Campo</label>
                            <input type="text" id="partido-estadio" placeholder="Nombre del campo">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Jornada/Ronda</label>
                            <input type="text" id="partido-jornada" placeholder="Jornada 1, Cuartos...">
                        </div>
                        <div class="form-group">
                            <label>Formato de juego</label>
                            <select id="partido-formato">
                                <option value="11">Fútbol 11</option>
                                <option value="8">Fútbol 8</option>
                                <option value="7">Fútbol 7</option>
                                <option value="5">Fútbol 5</option>
                            </select>
                        </div>
                    </div>
                </div>
                
              
<!-- DATOS DE CONVOCATORIA -->
<div class="seccion-modal">
    <h4 class="seccion-titulo">Datos de Convocatoria</h4>
    <div class="form-row">
        <div class="form-group">
            <label>Lugar de encuentro</label>
            <input type="text" id="partido-lugar-encuentro" placeholder="Vestuarios, parking...">
        </div>
        <div class="form-group">
            <label>Fecha de salida</label>
            <input type="date" id="partido-fecha-salida">
        </div>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label>Hora de salida</label>
            <input type="time" id="partido-hora-salida">
        </div>
        <div class="form-group"></div>
    </div>
    <div class="form-group">
        <label>Notas para jugadores</label>
        <textarea id="partido-notas-convocatoria" rows="2" placeholder="Llevar equipación azul, documentación..."></textarea>
    </div>
</div>
                
                <!-- CONVOCADOS -->
                <div class="seccion-modal">
                    <div class="seccion-titulo-con-contador">
                        <h4 class="seccion-titulo">Jugadores Convocados</h4>
                        <span id="contador-convocados" class="contador-jugadores">0 convocados</span>
                    </div>
                    <div id="convocatoria-grid" class="convocatoria-grid">
                        <div class="loading">Cargando jugadores...</div>
                    </div>
                </div>
                
                <!-- ALINEACIÓN -->
                <div class="seccion-modal">
                    <div class="seccion-titulo-con-contador">
                        <h4 class="seccion-titulo">Alineación</h4>
                        <span id="contador-titulares" class="contador-jugadores">0/<span id="max-titulares">11</span> titulares</span>
                    </div>
                    <p class="hint-text">Selecciona titulares de los convocados. El resto serán suplentes.</p>
                    <div id="alineacion-grid" class="alineacion-grid">
                        <p style="color:#9ca3af;font-size:13px;">Primero selecciona los convocados</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer modal-footer-partido">
                <div class="footer-izq">
                    <button class="btn-secondary" onclick="generarPDFConvocatoria()">📋 PDF Convocatoria</button>
                    <button class="btn-secondary" onclick="generarPDFAlineacion()">📝 PDF Alineación</button>
                </div>
                <div class="footer-der">
                    <button class="btn-secondary" onclick="cerrarModalPartido()">Cancelar</button>
                    <button class="btn-primary green" onclick="guardarPartido()">Guardar Partido</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================== MODAL: RESULTADO Y STATS ==================== -->
    <div id="modal-resultado" class="modal-overlay" style="display: none;" onclick="cerrarModalResultado(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>Resultado y Estadisticas</h3>
                <button class="modal-close" onclick="cerrarModalResultado()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="resultado-partido-id" value="">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Goles a favor</label>
                        <input type="number" id="resultado-favor" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>Goles en contra</label>
                        <input type="number" id="resultado-contra" min="0" value="0">
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px;">Estadisticas por Jugador</h4>
                    <div class="stats-labels">
                        <span>Jugador</span>
                        <span>Min</span>
                        <span>Goles</span>
                        <span>Asist.</span>
                        <span>TA</span>
                        <span>TR</span>
                    </div>
                    <div id="stats-jugadores-grid" class="stats-jugadores-grid">
                        <!-- Se genera dinámicamente -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModalResultado()">Cancelar</button>
                <button class="btn-primary green" onclick="guardarResultado()">Guardar Resultado</button>
            </div>
        </div>
    </div>
    
    <!-- ==================== MODAL: JUGADOR ==================== -->
    <div id="modal-jugador" class="modal-overlay" style="display: none;" onclick="cerrarModalJugador(event)">
        <div class="modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modal-jugador-titulo">Nuevo Jugador</h3>
                <button class="modal-close" onclick="cerrarModalJugador()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="jugador-id" value="">
                <input type="hidden" id="jugador-sp-id" value="">
                
                <div style="text-align: center; margin-bottom: 20px;">
                    <div class="escudo-upload" style="width: 80px; height: 80px; margin: 0 auto; border-radius: 50%;" onclick="document.getElementById('jugador-foto-input').click()">
                        <img id="jugador-foto-preview" src="" alt="" style="display: none; border-radius: 50%;">
                        <div id="jugador-foto-placeholder">
                            <div class="icon" style="font-size: 24px;">+</div>
                        </div>
                    </div>
                    <input type="file" id="jugador-foto-input" accept="image/*" style="display: none;" onchange="previsualizarFotoJugador(event)">
                </div>
                
                <div class="form-group">
                    <label>Nombre Completo *</label>
                    <input type="text" id="jugador-nombre" placeholder="Nombre y apellidos">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Dorsal *</label>
                        <input type="number" id="jugador-dorsal" min="1" max="99">
                    </div>
                    <div class="form-group">
                        <label>Posicion *</label>
                        <select id="jugador-posicion">
                            <option value="">Seleccionar...</option>
                            <option value="Portero">Portero</option>
                            <option value="Defensa Central">Defensa Central</option>
                            <option value="Lateral Derecho">Lateral Derecho</option>
                            <option value="Lateral Izquierdo">Lateral Izquierdo</option>
                            <option value="Mediocentro Defensivo">Mediocentro Defensivo</option>
                            <option value="Mediocentro">Mediocentro</option>
                            <option value="Mediapunta">Mediapunta</option>
                            <option value="Extremo Derecho">Extremo Derecho</option>
                            <option value="Extremo Izquierdo">Extremo Izquierdo</option>
                            <option value="Delantero Centro">Delantero Centro</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha Nacimiento</label>
                        <input type="date" id="jugador-nacimiento">
                    </div>
                    <div class="form-group">
                        <label>Pie Dominante</label>
                        <select id="jugador-pie">
                            <option value="Derecho">Derecho</option>
                            <option value="Izquierdo">Izquierdo</option>
                            <option value="Ambidiestro">Ambidiestro</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Altura (cm)</label>
                        <input type="number" id="jugador-altura" placeholder="175">
                    </div>
                    <div class="form-group">
                        <label>Peso (kg)</label>
                        <input type="number" id="jugador-peso" placeholder="70" step="0.1">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Telefono</label>
                        <input type="tel" id="jugador-telefono" placeholder="+34 600...">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="jugador-email" placeholder="jugador@email.com">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Estado</label>
                    <select id="jugador-estado">
                        <option value="available">Disponible</option>
                        <option value="injured">Lesionado</option>
                        <option value="suspended">Sancionado</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModalJugador()">Cancelar</button>
                <button class="btn-primary" onclick="guardarJugador()">Guardar</button>
            </div>
        </div>
    </div>
    
    <!-- ==================== MODAL: SELECCIÓN SECCIÓN ==================== -->
    <div id="modal-seccion" class="modal-overlay" style="display: none;" onclick="cerrarModalSeccion(event)">
        <div class="modal-content" style="max-width: 400px;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>Selecciona la Seccion</h3>
                <button class="modal-close" onclick="cerrarModalSeccion()">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="margin-bottom: 20px; color: #6b7280;">¿A que parte de la sesion quieres añadir este ejercicio?</p>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn-primary" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);" onclick="seleccionarSeccion('calentamiento')">Calentamiento</button>
                    <button class="btn-primary" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);" onclick="seleccionarSeccion('principal')">Parte Principal</button>
                    <button class="btn-primary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);" onclick="seleccionarSeccion('enfriamiento')">Enfriamiento</button>
                </div>
            </div>
        </div>
    </div>
<!-- ==================== MODAL: FICHA JUGADOR STATS ==================== -->
<div id="modal-ficha-jugador" class="modal-overlay" style="display: none;" onclick="cerrarModalFichaJugador(event)">
    <div class="modal-content" style="max-width: 800px;" onclick="event.stopPropagation()">
        <div class="modal-header" style="background: linear-gradient(135deg, #1f2937 0%, #374151 100%); color: white;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div id="ficha-foto" style="width: 60px; height: 60px; border-radius: 50%; background: #6b7280; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; overflow: hidden;">
                    ?
                </div>
                <div>
                    <h3 id="ficha-nombre" style="margin: 0;">Nombre del Jugador</h3>
                    <p id="ficha-posicion" style="margin: 5px 0 0; opacity: 0.8; font-size: 14px;">Posición</p>
                </div>
            </div>
            <button class="modal-close" onclick="cerrarModalFichaJugador()" style="color: white;">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Datos personales -->
            <div id="ficha-datos-personales" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; padding: 15px; background: #f8fafc; border-radius: 12px;">
                <!-- Se genera dinámicamente -->
            </div>
            
            <!-- Resumen estadísticas -->
            <h4 style="font-size: 14px; color: #374151; margin-bottom: 15px;">📊 Resumen de Temporada</h4>
            <div id="ficha-stats-resumen" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 25px;">
                <!-- Se genera dinámicamente -->
            </div>
            
            <!-- Detalle partido a partido -->
            <h4 style="font-size: 14px; color: #374151; margin-bottom: 15px;">⚽ Participación por Partido</h4>
            <div style="overflow-x: auto;">
                <table class="stats-tabla" id="ficha-partidos-tabla">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Rival</th>
                            <th>Resultado</th>
                            <th>Min</th>
                            <th>Goles</th>
                            <th>Asist</th>
                            <th>TA</th>
                            <th>TR</th>
                        </tr>
                    </thead>
                    <tbody id="ficha-partidos-body">
                        <!-- Se genera dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="cerrarModalFichaJugador()">Cerrar</button>
            <button class="btn-primary" onclick="exportarFichaJugadorPDF()">📄 Exportar PDF</button>
        </div>
    </div>
</div>
<!-- ==================== MODAL: CHAT STAFF ==================== -->
<div id="modal-chat-staff" class="modal-overlay" style="display: none;" onclick="cerrarChatStaff(event)">
    <div class="modal-content" style="max-width: 600px;" onclick="event.stopPropagation()">
        <div class="modal-header" id="chat-header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="staff-avatar" id="chat-avatar" style="width: 45px; height: 45px; font-size: 20px; margin: 0;"></div>
                <div>
                    <h3 id="chat-nombre" style="margin: 0;">Asistente</h3>
                    <p id="chat-rol" style="margin: 0; font-size: 12px; opacity: 0.8;"></p>
                </div>
            </div>
            <button class="modal-close" onclick="cerrarChatStaff()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 0;">
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <!-- Mensajes se generan dinámicamente -->
                </div>
                <div style="padding: 15px;">
                    <div class="chat-input-container">
                        <input type="text" id="chat-input" placeholder="Escribe tu consulta..." onkeypress="if(event.key==='Enter')enviarMensajeChat()">
                        <button onclick="enviarMensajeChat()">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <script>
        // ========== CONFIGURACIÓN ==========
        const API_BASE = 'https://toplidercoach.com/wp-json/toplider/v1';
        const SUPABASE_URL = 'https://cqteodxyvavyroxeshoz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxdGVvZHh5dmF2eXJveGVzaG96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNzc2OTksImV4cCI6MjA4MDg1MzY5OX0.8sJC6twae2pnrf8NDVlOV2KnSOhBC1RrqWC0IiuE614';
        
        let supabase = null;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('Supabase configurado');
        } catch (e) {
            console.error('Error Supabase:', e);
        }
        
        // ========== ESTADO GLOBAL ==========
        let usuario = null;
        let token = null;
        let clubId = null;
        let seasonId = null;
        let clubData = null;
        
        // Planificador
        let ejercicioSeleccionado = null;
        let paginaEjercicios = 1;
        let sesion = { nombre: '', fecha: '', calentamiento: [], principal: [], enfriamiento: [] };
        let calendarioMesSesiones = new Date().getMonth();
        let calendarioAnioSesiones = new Date().getFullYear();
        const MESES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        // MatchStats
        let filtroPartidos = 'todos';
        let convocadosPartido = [];
        let titularesPartido = [];
        let plantillaPartido = [];
        // Config
        let jugadorEditando = null;
        
        // ========== LOGIN ==========
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            if (!username || !password) {
                errorDiv.textContent = 'Por favor, introduce usuario y contrasena';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    usuario = data.user;
                    token = data.token;
                    localStorage.setItem('hub_user', JSON.stringify(usuario));
                    localStorage.setItem('hub_token', token);
                    mostrarApp();
                } else {
                    errorDiv.textContent = data.message || 'Error de autenticacion';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Error de conexion';
                errorDiv.style.display = 'block';
            }
        }
        
        function logout() {
            localStorage.removeItem('hub_user');
            localStorage.removeItem('hub_token');
            location.reload();
        }
        
        async function mostrarApp() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('user-name').textContent = usuario.name;
            
            await inicializarClub();
            
            // Inicializar fecha de sesion
            document.getElementById('sesion-fecha').value = new Date().toISOString().split('T')[0];
            
            // Cargar datos iniciales
             // Cargar datos iniciales
            cargarFiltrosOpciones();
            cargarEjercicios();
            cargarFiltrosOpciones();
            cargarEjercicios();
            cargarJugadoresSesion();
        }
        
        // ========== CLUB & TEMPORADA ==========
        async function inicializarClub() {
            try {
                let { data: club, error } = await supabase
                    .from('clubs')
                    .select('*')
                    .eq('wp_user_id', usuario.id)
                    .single();
                
                if (error && error.code === 'PGRST116') {
                    const { data: nuevoClub } = await supabase
                        .from('clubs')
                        .insert({
                            wp_user_id: usuario.id,
                            name: usuario.name || 'Mi Club',
                            team_format: '11',
                            max_players: 30
                        })
                        .select()
                        .single();
                    club = nuevoClub;
                }
                
                clubId = club.id;
                clubData = club;
                
                // Actualizar header
                document.getElementById('club-nombre-header').textContent = club.name;
                const inicial = club.name ? club.name.charAt(0).toUpperCase() : '?';
                document.getElementById('club-initial').textContent = inicial;
                
                if (club.logo_url) {
                    document.getElementById('club-badge').innerHTML = `
                        <img src="${club.logo_url}" alt="">
                        <span>${club.name}</span>
                    `;
                }
                
                await cargarTemporadaActiva();
                
            } catch (error) {
                console.error('Error inicializando club:', error);
            }
        }
        
        async function cargarTemporadaActiva() {
            try {
                const { data: temporada, error } = await supabase
                    .from('seasons')
                    .select('*')
                    .eq('club_id', clubId)
                    .eq('is_active', true)
                    .single();
                
                if (error && error.code === 'PGRST116') {
                    await crearTemporadaPorDefecto();
                } else if (!error) {
                    seasonId = temporada.id;
                }
            } catch (error) {
                console.error('Error cargando temporada:', error);
            }
        }
        
        async function crearTemporadaPorDefecto() {
            const hoy = new Date();
            const mes = hoy.getMonth();
            const anio = hoy.getFullYear();
            
            let nombreTemp = mes >= 7 ? `${anio}/${anio + 1}` : `${anio - 1}/${anio}`;
            let inicioTemp = mes >= 7 ? `${anio}-08-01` : `${anio - 1}-08-01`;
            let finTemp = mes >= 7 ? `${anio + 1}-06-30` : `${anio}-06-30`;
            
            const { data: nuevaTemp } = await supabase
                .from('seasons')
                .insert({
                    club_id: clubId,
                    name: nombreTemp,
                    start_date: inicioTemp,
                    end_date: finTemp,
                    is_active: true
                })
                .select()
                .single();
            
            seasonId = nuevaTemp.id;
        }
        
        // ========== NAVEGACIÓN ==========
        function cambiarModulo(modulo, tab) {
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            document.querySelectorAll('.vista-modulo').forEach(v => v.classList.remove('active'));
            document.getElementById(`modulo-${modulo}`).classList.add('active');
            
            // Cargar datos según módulo
            if (modulo === 'matchstats') {
                cargarPartidos();
            } else if (modulo === 'config') {
                cargarDatosClub();
            }
        }
        
        function cambiarSubTab(modulo, subtab, btn) {
            const container = document.getElementById(`modulo-${modulo}`);
            container.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            container.querySelectorAll('.vista-contenido').forEach(v => v.classList.remove('active'));
            document.getElementById(`${modulo}-${subtab}`).classList.add('active');
            
            // Cargar datos
            if (modulo === 'planificador') {
                if (subtab === 'mis-sesiones') cargarMisSesiones();
                else if (subtab === 'calendario') cargarCalendarioSesiones();
            } else if (modulo === 'matchstats') {
                if (subtab === 'estadisticas') {
                    cargarSelectorTemporadasStats();
                    cargarEstadisticas();
                }
            } else if (modulo === 'config') {
                if (subtab === 'temporadas') cargarTemporadas();
                else if (subtab === 'plantilla') {
                    cargarSelectorTemporadas();
                    cargarPlantilla();
                }
            }
        }
        
        // ========== PLANIFICADOR: EJERCICIOS ==========
        async function cargarEjercicios(pagina = 1) {
            paginaEjercicios = pagina;
            const lista = document.getElementById('lista-ejercicios');
            lista.innerHTML = '<div class="loading">Cargando...</div>';
            
            try {
                // Construir URL con filtros
                let url = `${API_BASE}/ejercicios?page=${pagina}&per_page=10`;
                
                const buscar = document.getElementById('filtro-buscar')?.value;
                const entrenador = document.getElementById('filtro-entrenador')?.value;
                const equipo = document.getElementById('filtro-equipo')?.value;
                const tema = document.getElementById('filtro-tema')?.value;
                const dificultad = document.getElementById('filtro-dificultad')?.value;
                
                if (buscar) url += `&search=${encodeURIComponent(buscar)}`;
                if (entrenador) url += `&entrenador=${encodeURIComponent(entrenador)}`;
                if (equipo) url += `&equipo=${encodeURIComponent(equipo)}`;
                if (tema) url += `&tema=${encodeURIComponent(tema)}`;
                if (dificultad) url += `&dificultad=${dificultad}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.ejercicios || data.ejercicios.length === 0) {
                    lista.innerHTML = '<p style="text-align:center;color:#9ca3af;">No hay ejercicios</p>';
                    return;
                }
                
                lista.innerHTML = data.ejercicios.map(ej => {
                    const ejercicioData = {
                        id: ej.id,
                        titulo: ej.titulo,
                        imagen: ej.imagen,
                        duracion: ej.duracion || 10
                    };
                    
                    return `
                    <div class="ejercicio-card" onclick="seleccionarEjercicio(${ej.id})">
                        <img src="${ej.imagen || 'https://via.placeholder.com/80x60?text=Sin+img'}" alt="">
                        <div class="info">
                            <div class="titulo">${ej.titulo}</div>
                            <div class="tags">
                                ${ej.tema ? `<span class="tag">${ej.tema}</span>` : ''}
                                ${ej.dificultad ? `<span class="tag dificultad">Dif: ${ej.dificultad}</span>` : ''}
                            </div>
                        </div>
                        <button class="btn-agregar" 
                                data-ejercicio='${JSON.stringify(ejercicioData).replace(/'/g, "&#39;")}'
                                onclick="event.stopPropagation(); agregarEjercicioDesdeBoton(this)">
                            + Anadir
                        </button>
                    </div>
                `}).join('');
                
                // Paginación
                const pag = document.getElementById('paginacion-ejercicios');
                pag.innerHTML = `
                    <button class="btn-secondary" onclick="cargarEjercicios(${pagina - 1})" ${pagina <= 1 ? 'disabled' : ''}>Anterior</button>
                    <span style="margin: 0 15px;">Pagina ${pagina}</span>
                    <button class="btn-secondary" onclick="cargarEjercicios(${pagina + 1})" ${data.ejercicios.length < 10 ? 'disabled' : ''}>Siguiente</button>
                `;
                
            } catch (error) {
                lista.innerHTML = '<p style="color:red;">Error al cargar</p>';
            }
        }
        let jugadoresPlantilla = [];
        let jugadoresSeleccionados = [];
        
        async function cargarJugadoresSesion() {
            const grid = document.getElementById('jugadores-sesion-grid');
            
            if (!seasonId) {
                grid.innerHTML = '<p style="color:#9ca3af;font-size:12px;grid-column:1/-1;text-align:center;">No hay temporada activa</p>';
                return;
            }
            
            try {
               const { data: jugadores, error } = await supabase
                    .from('season_players')
                    .select('id, player_id, shirt_number, players(id, name)')
                    .eq('season_id', seasonId)
                    .order('shirt_number');
                
                if (error) throw error;
                
                jugadoresPlantilla = jugadores || [];
                jugadoresSeleccionados = [];
                
                if (jugadoresPlantilla.length === 0) {
                    grid.innerHTML = '<p style="color:#9ca3af;font-size:12px;grid-column:1/-1;text-align:center;">No hay jugadores en la plantilla</p>';
                    return;
                }
                
                renderizarJugadoresSesion();
                
            } catch (error) {
                console.error('Error cargando jugadores:', error);
                grid.innerHTML = '<p style="color:red;font-size:12px;grid-column:1/-1;text-align:center;">Error al cargar</p>';
            }
        }
        
      function renderizarJugadoresSesion() {
            const grid = document.getElementById('jugadores-sesion-grid');
            
            grid.innerHTML = jugadoresPlantilla.map(sp => {
                const jugador = sp.players;
                const seleccionado = jugadoresSeleccionados.some(id => String(id) === String(sp.id));
                return `
                    <div class="jugador-check ${seleccionado ? 'selected' : ''}" data-id="${sp.id}">
                        <span class="dorsal">${sp.shirt_number || '?'}</span>
                        <span class="nombre">${jugador?.name || 'Sin nombre'}</span>
                    </div>
                `;
            }).join('');
            
            // Añadir eventos de clic
            grid.querySelectorAll('.jugador-check').forEach(el => {
                el.addEventListener('click', function() {
                    const spId = this.dataset.id;
                    toggleJugadorSesion(spId);
                });
            });
            
            actualizarContadorJugadores();
        }
        
      function toggleJugadorSesion(spId) {
            const idx = jugadoresSeleccionados.findIndex(id => String(id) === String(spId));
            if (idx > -1) {
                jugadoresSeleccionados.splice(idx, 1);
            } else {
                jugadoresSeleccionados.push(spId);
            }
            renderizarJugadoresSesion();
        }
        
        function toggleTodosJugadores() {
            if (jugadoresSeleccionados.length === jugadoresPlantilla.length) {
                jugadoresSeleccionados = [];
            } else {
                jugadoresSeleccionados = jugadoresPlantilla.map(sp => sp.id);
            }
            renderizarJugadoresSesion();
        }
        
        function actualizarContadorJugadores() {
            document.getElementById('contador-jugadores').textContent = `${jugadoresSeleccionados.length} seleccionados`;
        }
        
        function obtenerJugadoresParaGuardar() {
            return jugadoresPlantilla
                .filter(sp => jugadoresSeleccionados.includes(sp.id))
                .map(sp => ({
                    id: sp.id,
                    player_id: sp.player_id,
                    name: sp.players?.name || '',
                    shirt_number: sp.shirt_number,
                    position: sp.position
                }));
        }
      function toggleInfoSesion() {
            const info = document.getElementById('sesion-info-grid');
            const toggle = document.querySelector('.info-sesion-toggle');
            info.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }
        function toggleFiltros() {
            const filtros = document.getElementById('filtros-biblioteca');
            const toggle = document.getElementById('filtros-toggle');
            filtros.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }
        function limpiarFiltros() {
            document.getElementById('filtro-buscar').value = '';
            document.getElementById('filtro-entrenador').value = '';
            document.getElementById('filtro-equipo').value = '';
            document.getElementById('filtro-tema').value = '';
            document.getElementById('filtro-dificultad').value = '';
            cargarEjercicios(1);
        }
        
    async function cargarFiltrosOpciones() {
            try {
                const response = await fetch(`${API_BASE}/filtros`);
                const data = await response.json();
                
                if (data.success && data.filtros) {
                    if (data.filtros.entrenadores) {
                        const select = document.getElementById('filtro-entrenador');
                        data.filtros.entrenadores.forEach(e => {
                            select.innerHTML += `<option value="${e}">${e.replace(/_/g, ' ')}</option>`;
                        });
                    }
                    
                    if (data.filtros.equipos) {
                        const select = document.getElementById('filtro-equipo');
                        data.filtros.equipos.forEach(e => {
                            select.innerHTML += `<option value="${e}">${e.replace(/_/g, ' ')}</option>`;
                        });
                    }
                    
                    if (data.filtros.temas) {
                        const select = document.getElementById('filtro-tema');
                        data.filtros.temas.forEach(t => {
                            select.innerHTML += `<option value="${t}">${t}</option>`;
                        });
                    }
                }
            } catch (error) {
                console.error('Error cargando filtros:', error);
            }
        }
        
        function seleccionarEjercicio(ejercicioId) {
            const detalle = document.getElementById('detalle-ejercicio');
            detalle.innerHTML = '<div class="loading">Cargando detalles...</div>';
            
            fetch(`${API_BASE}/ejercicio/${ejercicioId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const ej = data.ejercicio;
                        ejercicioSeleccionado = ej;
                        
                        detalle.className = 'detalle-ejercicio active';
                        detalle.innerHTML = `
                            <img src="${ej.imagen || 'https://via.placeholder.com/400x300?text=Sin+imagen'}" alt="${ej.titulo}">
                            <h3>${ej.titulo}</h3>
                            <div class="meta" style="font-size:13px;color:#666;line-height:1.8;margin-bottom:10px;">
                                ${ej.entrenador ? `<strong>Entrenador:</strong> ${ej.entrenador.replace(/_/g, ' ')}<br>` : ''}
                                ${ej.equipo ? `<strong>Equipo:</strong> ${ej.equipo.replace(/_/g, ' ')}<br>` : ''}
                                ${ej.tema ? `<strong>Tema:</strong> ${ej.tema}<br>` : ''}
                                ${ej.dificultad ? `<strong>Dificultad:</strong> ${ej.dificultad}<br>` : ''}
                                <strong>Duracion:</strong> ${ej.duracion || 10} min
                            </div>
                            ${ej.objetivo ? `
                                <div class="detalle-seccion">
                                    <h4>Objetivo</h4>
                                    <p>${ej.objetivo}</p>
                                </div>
                            ` : ''}
                            ${ej.organizacion ? `
                                <div class="detalle-seccion">
                                    <h4>Organizacion y Desarrollo</h4>
                                    <p>${ej.organizacion}</p>
                                </div>
                            ` : ''}
                            ${ej.url ? `<a href="${ej.url}" target="_blank" class="btn-ver-completo">Ver ejercicio completo</a>` : ''}
                            <button class="btn-primary purple" style="width:100%;margin-top:10px;" onclick="abrirModalSeccion()">Anadir a Sesion</button>
                        `;
                    } else {
                        detalle.innerHTML = '<p style="color:red;">Error al cargar el ejercicio</p>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    detalle.innerHTML = '<p style="color:red;">Error de conexion</p>';
                });
        }
        
        function abrirModalSeccion() {
            if (!ejercicioSeleccionado) return;
            document.getElementById('modal-seccion').style.display = 'flex';
        }
        
        function cerrarModalSeccion(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modal-seccion').style.display = 'none';
        }
        
    function seleccionarSeccion(seccion) {
            if (!ejercicioSeleccionado) return;
            
            // Funcion para limpiar HTML
            function limpiarHTML(html) {
                if (!html) return '';
                const temp = document.createElement('div');
                temp.innerHTML = html;
                return temp.textContent || temp.innerText || '';
            }
            
            const ejercicioParaSesion = {
                id: ejercicioSeleccionado.id,
                titulo: ejercicioSeleccionado.titulo,
                duracion: ejercicioSeleccionado.duracion || 10,
                imagen: ejercicioSeleccionado.imagen || '',
                objetivo: limpiarHTML(ejercicioSeleccionado.objetivo),
                entrenador: ejercicioSeleccionado.entrenador || '',
                equipo: ejercicioSeleccionado.equipo || ''
            };
            
            sesion[seccion].push(ejercicioParaSesion);
            cerrarModalSeccion();
            renderizarSesion();
        }
        
        async function agregarEjercicioDesdeBoton(btn) {
            const ejercicioData = JSON.parse(btn.dataset.ejercicio);
            
            // Cargar detalles completos del ejercicio
            try {
                const response = await fetch(`${API_BASE}/ejercicio/${ejercicioData.id}`);
                const data = await response.json();
                
                if (data.success) {
                    const ej = data.ejercicio;
                    
                    // Funcion para limpiar HTML
                    function limpiarHTML(html) {
                        if (!html) return '';
                        const temp = document.createElement('div');
                        temp.innerHTML = html;
                        return temp.textContent || temp.innerText || '';
                    }
                    
                    ejercicioSeleccionado = {
                        id: ej.id,
                        titulo: ej.titulo,
                        duracion: ej.duracion || 10,
                        imagen: ej.imagen || '',
                        objetivo: limpiarHTML(ej.objetivo),
                        entrenador: ej.entrenador || '',
                        equipo: ej.equipo || ''
                    };
                    
                    abrirModalSeccion();
                }
            } catch (error) {
                console.error('Error cargando ejercicio:', error);
                alert('Error al cargar el ejercicio');
            }
        }
        
        function renderizarSesion() {
            let duracionTotal = 0;
            
            ['calentamiento', 'principal', 'enfriamiento'].forEach(seccion => {
                const lista = document.getElementById(`lista-${seccion}`);
                const tiempo = document.getElementById(`tiempo-${seccion}`);
                
                const totalMin = sesion[seccion].reduce((sum, ej) => sum + (ej.duracion || 0), 0);
                duracionTotal += totalMin;
                tiempo.textContent = `${totalMin} min`;
                
                if (sesion[seccion].length === 0) {
                    lista.innerHTML = '<p style="text-align:center;color:#9ca3af;padding:20px;font-size:13px;">Arrastra ejercicios aqui</p>';
              } else {
                    lista.innerHTML = sesion[seccion].map((ej, idx) => `
                        <div class="ejercicio-en-sesion" onclick="seleccionarEjercicio(${ej.id})" style="cursor: pointer;">
                            <div>
                                <div class="nombre">${ej.titulo}</div>
                                <div class="duracion">${ej.duracion} min</div>
                            </div>
                            <button onclick="event.stopPropagation(); quitarEjercicio('${seccion}', ${idx})">Quitar</button>
                        </div>
                    `).join('');
                }
            });
            
            document.getElementById('duracion-total').textContent = `${duracionTotal} min`;
        }
        function quitarEjercicio(seccion, idx) {
            sesion[seccion].splice(idx, 1);
            renderizarSesion();
        }
        
       function limpiarSesion() {
            sesion = { nombre: '', fecha: new Date().toISOString().split('T')[0], calentamiento: [], principal: [], enfriamiento: [] };
            document.getElementById('sesion-nombre').value = '';
            document.getElementById('sesion-fecha').value = sesion.fecha;
            document.getElementById('sesion-hora').value = '';
            document.getElementById('sesion-microciclo').value = '';
            document.getElementById('sesion-md').value = '';
            document.getElementById('sesion-jugadores').value = '';
            document.getElementById('sesion-equipo').value = '';
            document.getElementById('sesion-objetivo').value = '';
            document.getElementById('sesion-material').value = '';
            document.getElementById('sesion-notas').value = '';
            renderizarSesion();
            jugadoresSeleccionados = [];
            renderizarJugadoresSesion();
        }
        
        async function guardarSesion() {
            const nombre = document.getElementById('sesion-nombre').value.trim();
            const fecha = document.getElementById('sesion-fecha').value;
            const hora = document.getElementById('sesion-hora').value;
            const microciclo = document.getElementById('sesion-microciclo').value.trim();
            const md = document.getElementById('sesion-md').value.trim();
            const jugadores = document.getElementById('sesion-jugadores').value;
            const equipo = document.getElementById('sesion-equipo').value.trim();
            const objetivo = document.getElementById('sesion-objetivo').value.trim();
            const material = document.getElementById('sesion-material').value.trim();
            const notas = document.getElementById('sesion-notas').value.trim();
            
            if (!nombre) {
                alert('El nombre de la sesion es obligatorio');
                return;
            }
            
            if (sesion.calentamiento.length === 0 && sesion.principal.length === 0 && sesion.enfriamiento.length === 0) {
                alert('Anade al menos un ejercicio a la sesion');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('training_sessions')
                    .insert({
                        club_id: clubId,
                        season_id: seasonId,
                        name: nombre,
                        session_date: fecha,
                        session_time: hora || null,
                        microciclo: microciclo || null,
                        match_day: md || null,
                        num_players: jugadores ? parseInt(jugadores) : null,
                        team_category: equipo || null,
                        objective: objetivo || null,
                        materials: material || null,
                        notes: notas || null,
                        warm_up: sesion.calentamiento,
                        main_part: sesion.principal,
                        cool_down: sesion.enfriamiento,
                        players: obtenerJugadoresParaGuardar()
                    });
                
                if (error) throw error;
                
                alert('Sesion guardada correctamente');
                limpiarSesion();
                
            } catch (error) {
                alert('Error al guardar: ' + error.message);
            }
        }
        
        // ========== PLANIFICADOR: MIS SESIONES ==========
        async function cargarMisSesiones() {
            const lista = document.getElementById('lista-mis-sesiones');
            lista.innerHTML = '<div class="loading">Cargando sesiones...</div>';
            
            try {
                const fechaDesde = document.getElementById('filtro-sesion-desde').value;
                const fechaHasta = document.getElementById('filtro-sesion-hasta').value;
                
                let query = supabase
                    .from('training_sessions')
                    .select('*')
                    .eq('club_id', clubId);
                
                if (fechaDesde) query = query.gte('session_date', fechaDesde);
                if (fechaHasta) query = query.lte('session_date', fechaHasta);
                
                query = query.order('session_date', { ascending: false });
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    lista.innerHTML = '<div class="empty-state"><h3>No hay sesiones guardadas</h3><p>Crea tu primera sesion de entrenamiento</p></div>';
                    return;
                }
                
                lista.innerHTML = data.map(s => {
                    const cal = s.warm_up || [];
                    const pri = s.main_part || [];
                    const enf = s.cool_down || [];
                    
                    const tCal = cal.reduce((sum, ej) => sum + (ej.duracion || 0), 0);
                    const tPri = pri.reduce((sum, ej) => sum + (ej.duracion || 0), 0);
                    const tEnf = enf.reduce((sum, ej) => sum + (ej.duracion || 0), 0);
                    
                    const fecha = new Date(s.session_date).toLocaleDateString('es-ES');
                    
                    return `
                        <div class="sesion-card">
                            <div class="sesion-card-header">
                                <h3>${s.name}</h3>
                                <div class="sesion-card-meta">
                                    <span>Fecha: ${fecha}</span>
                                </div>
                            </div>
                            <div class="sesion-card-resumen">
                                <div class="seccion-resumen calentamiento">
                                    <strong>${cal.length}</strong>
                                    ejercicios<br>${tCal} min
                                </div>
                                <div class="seccion-resumen principal">
                                    <strong>${pri.length}</strong>
                                    ejercicios<br>${tPri} min
                                </div>
                                <div class="seccion-resumen enfriamiento">
                                    <strong>${enf.length}</strong>
                                    ejercicios<br>${tEnf} min
                                </div>
                            </div>
                            <div class="sesion-card-actions">
                                <button class="btn-cargar" onclick="cargarSesionEnEditor('${s.id}')">Cargar</button>
                                <button class="btn-pdf-sesion" onclick="exportarSesionPDF('${s.id}')">PDF</button>
                                <button class="btn-eliminar-sesion" onclick="eliminarSesion('${s.id}')">Eliminar</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                lista.innerHTML = '<p style="color:red;">Error al cargar</p>';
            }
        }
        
        function limpiarFiltroSesiones() {
            document.getElementById('filtro-sesion-desde').value = '';
            document.getElementById('filtro-sesion-hasta').value = '';
            cargarMisSesiones();
        }
        
        async function cargarSesionEnEditor(id) {
            try {
                const { data } = await supabase
                    .from('training_sessions')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                sesion = {
                    nombre: data.name,
                    fecha: data.session_date,
                    calentamiento: data.warm_up || [],
                    principal: data.main_part || [],
                    enfriamiento: data.cool_down || []
                };
                
                document.getElementById('sesion-nombre').value = data.name;
                document.getElementById('sesion-fecha').value = data.session_date;
                
                renderizarSesion();
                
                // Cambiar a pestaña crear
                document.querySelector('.planificador-subtabs .sub-tab').click();
                
            } catch (error) {
                alert('Error al cargar sesion');
            }
        }
        
        async function eliminarSesion(id) {
            if (!confirm('¿Eliminar esta sesion?')) return;
            
            await supabase.from('training_sessions').delete().eq('id', id);
            cargarMisSesiones();
        }
        
async function exportarSesionPDF(id) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const { data: s } = await supabase.from('training_sessions').select('*').eq('id', id).single();
            const { data: club } = await supabase.from('clubs').select('name, logo_url').eq('id', clubId).single();
            
            const fecha = new Date(s.session_date).toLocaleDateString('es-ES');
            const hora = s.session_time ? s.session_time.substring(0, 5) : '';
            
            // Funcion para limpiar texto
            function limpiarTexto(texto) {
                if (!texto) return '';
                return texto
                    .replace(/<[^>]*>/g, '')
                    .replace(/[\u{1F300}-\u{1F9FF}]/gu, '')
                    .replace(/[\u{2600}-\u{26FF}]/gu, '')
                    .replace(/[\u{2700}-\u{27BF}]/gu, '')
                    .replace(/[\u{FE00}-\u{FE0F}]/gu, '')
                    .replace(/[\u{1F000}-\u{1F02F}]/gu, '')
                    .replace(/[^\x00-\x7F\xA0-\xFF\u0100-\u017F]/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
            }
            
            // Calcular duracion total
            const duracionTotal = (s.warm_up || []).reduce((sum, e) => sum + (e.duracion || 0), 0) +
                                  (s.main_part || []).reduce((sum, e) => sum + (e.duracion || 0), 0) +
                                  (s.cool_down || []).reduce((sum, e) => sum + (e.duracion || 0), 0);
            
            // ===== HEADER =====
            doc.setFillColor(0, 51, 102);
            doc.rect(0, 0, 210, 28, 'F');
            
            // Escudo del club (si existe)
            let tituloX = 10;
            if (club && club.logo_url) {
                try {
                    doc.addImage(club.logo_url, 'PNG', 8, 3, 22, 22);
                    tituloX = 35;
                } catch (e) {
                    console.log('No se pudo cargar el escudo');
                }
            }
            
            // Titulo sesion
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(s.name.toUpperCase(), tituloX, 10);
            
            // Nombre del club
            if (club && club.name) {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(club.name, tituloX, 16);
            }
            
            // Info en header (fila)
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            
            const headerInfo = [];
            headerInfo.push(`Fecha: ${fecha}`);
            if (hora) headerInfo.push(`Hora: ${hora}`);
            if (s.microciclo) headerInfo.push(`Microciclo: ${s.microciclo}`);
            if (s.match_day) headerInfo.push(`MD: ${s.match_day}`);
            if (s.num_players) headerInfo.push(`Jugadores: ${s.num_players}`);
            if (s.team_category) headerInfo.push(`Equipo: ${s.team_category}`);
            headerInfo.push(`Duracion: ${duracionTotal} min`);
            
            doc.text(headerInfo.join('   |   '), tituloX, 24);
            
            // Linea amarilla decorativa
            doc.setFillColor(255, 204, 0);
            doc.rect(0, 28, 210, 2, 'F');
            
            let y = 35;
            
            // ===== Jugadores aptos para entrenar =====
         // ===== Jugadores aptos para entrenar =====
if (s.players && s.players.length > 0) {
    const nombresJugadores = s.players.map(j => `${j.shirt_number || '?'}.${j.name}`).join('  |  ');
    const jugadoresLines = doc.splitTextToSize(nombresJugadores, 155);
    const alturaBloque = 10 + (jugadoresLines.length * 4);
    
    doc.setFillColor(240, 240, 240);
    doc.rect(10, y, 190, alturaBloque, 'F');
    
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(0, 51, 102);
    doc.text('CONVOCADOS:', 12, y + 5);
    
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(50, 50, 50);
    doc.setFontSize(7);
    
    jugadoresLines.forEach((linea, idx) => {
        doc.text(linea, 38, y + 5 + (idx * 4));
    });
    
    y += alturaBloque + 4;
}
            
            y += 3;
            
            // ===== OBJETIVO GENERAL =====
            if (s.objective) {
                doc.setFillColor(240, 240, 240);
                doc.rect(10, y - 4, 190, 12, 'F');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 51, 102);
                doc.text('OBJETIVO:', 12, y + 2);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(50, 50, 50);
                const objText = doc.splitTextToSize(limpiarTexto(s.objective), 150);
                doc.text(objText[0], 35, y + 2);
                y += 14;
            }
            
            // ===== MATERIAL =====
            if (s.materials) {
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(100, 100, 100);
                doc.text('Material: ', 10, y);
                doc.setFont('helvetica', 'normal');
                doc.text(limpiarTexto(s.materials), 28, y);
                y += 8;
            }
            
            // ===== SECCIONES =====
            const secciones = [
                { nombre: 'CALENTAMIENTO', datos: s.warm_up || [], color: [255, 153, 0] },
                { nombre: 'PARTE PRINCIPAL', datos: s.main_part || [], color: [0, 102, 204] },
                { nombre: 'PARTE FINAL', datos: s.cool_down || [], color: [0, 153, 76] }
            ];
            
            for (const sec of secciones) {
                if (sec.datos.length > 0) {
                    const tiempoSeccion = sec.datos.reduce((sum, e) => sum + (e.duracion || 0), 0);
                    
                    // Verificar espacio para header de seccion
                    if (y > 260) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    // Header seccion
                    doc.setFillColor(...sec.color);
                    doc.rect(10, y, 190, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(sec.nombre, 12, y + 6);
                    doc.text(tiempoSeccion + ' min', 195, y + 6, { align: 'right' });
                    y += 12;
                    
                    // Ejercicios de la seccion
                    for (let i = 0; i < sec.datos.length; i++) {
                        const ej = sec.datos[i];
                        const alturaEjercicio = 45;
                        
                        // Verificar espacio, nueva pagina si necesario
                        if (y + alturaEjercicio > 280) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        // Fila del titulo
                        doc.setFillColor(245, 245, 245);
                        doc.rect(10, y, 190, 7, 'F');
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${i + 1}. ${ej.titulo}`, 12, y + 5);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(100, 100, 100);
                        doc.text(`${ej.duracion} min`, 195, y + 5, { align: 'right' });
                        y += 9;
                        
                        const contenidoY = y;
                        
                        // === COLUMNA 1: IMAGEN (izquierda) ===
                        const imgX = 10;
                        const imgWidth = 55;
                        const imgHeight = 35;
                        
                        if (ej.imagen) {
                            try {
                                doc.addImage(ej.imagen, 'JPEG', imgX, contenidoY, imgWidth, imgHeight);
                            } catch (e) {
                                doc.setDrawColor(200, 200, 200);
                                doc.rect(imgX, contenidoY, imgWidth, imgHeight);
                                doc.setFontSize(7);
                                doc.setTextColor(150, 150, 150);
                                doc.text('Sin imagen', imgX + 18, contenidoY + 18);
                            }
                        } else {
                            doc.setDrawColor(200, 200, 200);
                            doc.rect(imgX, contenidoY, imgWidth, imgHeight);
                            doc.setFontSize(7);
                            doc.setTextColor(150, 150, 150);
                            doc.text('Sin imagen', imgX + 18, contenidoY + 18);
                        }
                        
                        // === COLUMNA 2: DESCRIPCION (centro) ===
                        const descX = 70;
                        const descWidth = 65;
                        
                        doc.setDrawColor(230, 230, 230);
                        doc.rect(descX, contenidoY, descWidth, imgHeight);
                        
                        if (ej.objetivo) {
                            doc.setFontSize(7);
                            doc.setTextColor(60, 60, 60);
                            const objetivoLimpio = limpiarTexto(ej.objetivo);
                            const objetivoLines = doc.splitTextToSize(objetivoLimpio, descWidth - 4);
                            const lineasMostrar = objetivoLines.slice(0, 8);
                            doc.text(lineasMostrar, descX + 2, contenidoY + 4);
                        } else {
                            doc.setFontSize(7);
                            doc.setTextColor(180, 180, 180);
                            doc.text('Sin descripcion', descX + 15, contenidoY + 18);
                        }
                        
                        // === COLUMNA 3: NOTAS ENTRENADOR (derecha) ===
                        const notasX = 140;
                        const notasWidth = 60;
                        
                        doc.setDrawColor(230, 230, 230);
                        doc.rect(notasX, contenidoY, notasWidth, imgHeight);
                        
                        // Titulo "Notas"
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(150, 150, 150);
                        doc.text('Notas:', notasX + 2, contenidoY + 4);
                        doc.setFont('helvetica', 'normal');
                        
                        // Lineas para escribir
                        doc.setDrawColor(220, 220, 220);
                        for (let lineY = contenidoY + 10; lineY < contenidoY + imgHeight - 2; lineY += 6) {
                            doc.line(notasX + 2, lineY, notasX + notasWidth - 2, lineY);
                        }
                        
                        y = contenidoY + imgHeight + 5;
                    }
                    
                    y += 5;
                }
            }
            
            // ===== NOTAS GENERALES =====
            if (s.notes) {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFillColor(255, 255, 200);
                const notasLines = doc.splitTextToSize(limpiarTexto(s.notes), 180);
                doc.rect(10, y, 190, 8 + notasLines.length * 4, 'F');
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(100, 80, 0);
                doc.text('NOTAS:', 12, y + 5);
                doc.setFont('helvetica', 'normal');
                doc.text(notasLines, 30, y + 5);
            }
            
            // ===== FOOTER =====
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                doc.text('TopLiderCoach.com', 105, 292, { align: 'center' });
            }
            
            doc.save(`sesion_${s.name.replace(/\s+/g, '_')}.pdf`);
        }
            
          
       
        
        // ========== PLANIFICADOR: CALENDARIO ==========
      
        
        async function cargarCalendarioSesiones() {
            document.getElementById('mes-actual-sesiones').textContent = `${MESES[calendarioMesSesiones]} ${calendarioAnioSesiones}`;
            
            const primerDia = new Date(calendarioAnioSesiones, calendarioMesSesiones, 1);
            const ultimoDia = new Date(calendarioAnioSesiones, calendarioMesSesiones + 1, 0);
            
            // Cargar sesiones del mes
            const inicioMes = `${calendarioAnioSesiones}-${String(calendarioMesSesiones + 1).padStart(2, '0')}-01`;
            const finMes = `${calendarioAnioSesiones}-${String(calendarioMesSesiones + 1).padStart(2, '0')}-${ultimoDia.getDate()}`;
            
            const { data: sesiones } = await supabase
                .from('training_sessions')
                .select('id, name, session_date')
                .eq('club_id', clubId)
                .gte('session_date', inicioMes)
                .lte('session_date', finMes);
            
            const sesionesPorDia = {};
            (sesiones || []).forEach(s => {
                const dia = new Date(s.session_date).getDate();
                if (!sesionesPorDia[dia]) sesionesPorDia[dia] = [];
                sesionesPorDia[dia].push(s);
            });
            
            // Generar calendario
            const grid = document.getElementById('calendario-sesiones');
            let html = '';
            
            // Headers
            ['Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab', 'Dom'].forEach(d => {
                html += `<div class="calendario-dia-header">${d}</div>`;
            });
            
            // Días vacíos al inicio
            let diaInicio = primerDia.getDay() || 7;
            for (let i = 1; i < diaInicio; i++) {
                html += '<div class="calendario-dia otro-mes"></div>';
            }
            
            // Días del mes
            const hoy = new Date();
            for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
                const esHoy = dia === hoy.getDate() && calendarioMesSesiones === hoy.getMonth() && calendarioAnioSesiones === hoy.getFullYear();
                
                let eventosHTML = '';
                if (sesionesPorDia[dia]) {
                    sesionesPorDia[dia].forEach(s => {
                        eventosHTML += `<div class="calendario-evento sesion" onclick="cargarSesionEnEditor('${s.id}')">${s.name}</div>`;
                    });
                }
                
                html += `
                    <div class="calendario-dia ${esHoy ? 'hoy' : ''}">
                        <div class="numero">${dia}</div>
                        ${eventosHTML}
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }
        
        function mesAnteriorSesiones() {
            calendarioMesSesiones--;
            if (calendarioMesSesiones < 0) {
                calendarioMesSesiones = 11;
                calendarioAnioSesiones--;
            }
            cargarCalendarioSesiones();
        }
        
        function mesSiguienteSesiones() {
            calendarioMesSesiones++;
            if (calendarioMesSesiones > 11) {
                calendarioMesSesiones = 0;
                calendarioAnioSesiones++;
            }
            cargarCalendarioSesiones();
        }
        
        // ========== MATCHSTATS: PARTIDOS ==========
        function filtrarPartidos(filtro, btn) {
            document.querySelectorAll('.filtros-bar .filtro-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filtroPartidos = filtro;
            cargarPartidos();
        }
        
        async function cargarPartidos() {
            const lista = document.getElementById('lista-partidos');
            lista.innerHTML = '<div class="loading">Cargando partidos...</div>';
            
            try {
                let query = supabase
                    .from('matches')
                    .select('*')
                    .eq('club_id', clubId)
                    .eq('season_id', seasonId)
                    .order('match_date', { ascending: false });
                
                const hoy = new Date().toISOString().split('T')[0];
                
                if (filtroPartidos === 'proximos') {
                    query = query.gte('match_date', hoy).is('result', null);
                } else if (filtroPartidos === 'jugados') {
                    query = query.not('result', 'is', null);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    lista.innerHTML = '<div class="empty-state"><h3>No hay partidos</h3><p>Crea tu primer partido</p></div>';
                    return;
                }
                
                lista.innerHTML = data.map(p => {
                    const fecha = new Date(p.match_date).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
                    const hora = p.kick_off_time ? p.kick_off_time.slice(0, 5) : '';
                    const esLocal = p.home_away === 'home';
                    
                    let resultadoHTML = '';
                    let badgeHTML = '';
                    
                    if (p.result) {
                        const gF = p.team_goals || 0;
                        const gC = p.opponent_goals || 0;
                        const marcador = esLocal ? `${gF} - ${gC}` : `${gC} - ${gF}`;
                        resultadoHTML = `<span class="partido-resultado">${marcador}</span>`;
                        
                        const badgeClass = p.result === 'win' ? 'victoria' : p.result === 'draw' ? 'empate' : 'derrota';
                        const badgeText = p.result === 'win' ? 'Victoria' : p.result === 'draw' ? 'Empate' : 'Derrota';
                        badgeHTML = `<span class="resultado-badge ${badgeClass}">${badgeText}</span>`;
                    } else {
                        resultadoHTML = `<span class="partido-resultado pendiente">${hora || 'Por jugar'}</span>`;
                        badgeHTML = `<span class="resultado-badge pendiente">Pendiente</span>`;
                    }
                    
                    return `
                        <div class="partido-card">
                            <div class="partido-card-header">
                                <div class="partido-fecha">${fecha} ${hora ? '- ' + hora : ''}</div>
                                ${p.competition ? `<span class="partido-competicion">${p.competition}</span>` : ''}
                            </div>
                            <div class="partido-card-body">
                                <div class="partido-equipos">
                                    <div class="equipo">
                                        <div class="equipo-nombre">${esLocal ? (clubData?.name || 'Mi Equipo') : p.opponent}</div>
                                        <div class="equipo-tipo">${esLocal ? 'Local' : 'Visitante'}</div>
                                    </div>
                                    ${resultadoHTML}
                                    <div class="equipo">
                                        <div class="equipo-nombre">${esLocal ? p.opponent : (clubData?.name || 'Mi Equipo')}</div>
                                        <div class="equipo-tipo">${esLocal ? 'Visitante' : 'Local'}</div>
                                    </div>
                                </div>
                                ${badgeHTML}
                            </div>
                           <div class="partido-card-footer">
    <button class="btn-ver" onclick="verPartido('${p.id}')">Ver</button>
    <button class="btn-stats" onclick="editarPartido('${p.id}')">Editar</button>
    <button class="btn-pdf" onclick="abrirModalResultado('${p.id}')">Stats</button>
    <button class="btn-eliminar" onclick="eliminarPartido('${p.id}')">X</button>
</div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                lista.innerHTML = '<p style="color:red;">Error al cargar partidos</p>';
            }
        }
        
     async function abrirModalPartido(partidoId = null) {
            document.getElementById('modal-partido-titulo').textContent = partidoId ? 'Editar Partido' : 'Nuevo Partido';
            
            // Limpiar todo
            document.getElementById('partido-id').value = '';
            document.getElementById('partido-rival').value = '';
            document.getElementById('partido-competicion').value = '';
            document.getElementById('partido-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('partido-hora').value = '';
            document.getElementById('partido-localidad').value = 'home';
            document.getElementById('partido-estadio').value = '';
            document.getElementById('partido-jornada').value = '';
            document.getElementById('partido-formato').value = '11';
            document.getElementById('partido-lugar-encuentro').value = '';
            document.getElementById('partido-hora-salida').value = '';
            document.getElementById('partido-fecha-salida').value = '';
            document.getElementById('partido-notas-convocatoria').value = '';
            
            convocadosPartido = [];
            titularesPartido = [];
            
            await cargarConvocatoria();
            
            if (partidoId) {
                const { data: p } = await supabase.from('matches').select('*').eq('id', partidoId).single();
                if (p) {
                    document.getElementById('partido-id').value = p.id;
                    document.getElementById('partido-rival').value = p.opponent || '';
                    document.getElementById('partido-competicion').value = p.competition || '';
                    document.getElementById('partido-fecha').value = p.match_date || '';
                    document.getElementById('partido-hora').value = p.kick_off_time || '';
                    document.getElementById('partido-localidad').value = p.home_away || 'home';
                    document.getElementById('partido-estadio').value = p.stadium || '';
                    document.getElementById('partido-jornada').value = p.round || '';
                    document.getElementById('partido-formato').value = p.formato_juego || '11';
                    document.getElementById('partido-lugar-encuentro').value = p.lugar_encuentro || '';
                    document.getElementById('partido-hora-salida').value = p.hora_salida || '';
                    document.getElementById('partido-fecha-salida').value = p.fecha_salida || '';
                    document.getElementById('partido-notas-convocatoria').value = p.notas_convocatoria || '';
                    
                    // Cargar convocados
if (p.convocados && Array.isArray(p.convocados)) {
    convocadosPartido = p.convocados.map(c => String(c.id));
}

// Cargar titulares
if (p.titulares && Array.isArray(p.titulares)) {
    titularesPartido = p.titulares.map(t => String(t.id));
}
                    
                    renderizarConvocatoria();
                }
            }
            
            document.getElementById('modal-partido').style.display = 'flex';
        }
        async function verPartido(partidoId) {
    const { data: p } = await supabase.from('matches').select('*').eq('id', partidoId).single();
    if (!p) {
        alert('Partido no encontrado');
        return;
    }
    
    const { data: club } = await supabase.from('clubs').select('name, logo_url').eq('id', clubId).single();
    
    const fecha = new Date(p.match_date).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    const hora = p.kick_off_time ? p.kick_off_time.slice(0, 5) : '';
    const esLocal = p.home_away === 'home';
    
    // Resultado
    let resultadoHTML = '';
    if (p.result) {
        const gF = p.team_goals || 0;
        const gC = p.opponent_goals || 0;
        const marcador = esLocal ? `${gF} - ${gC}` : `${gC} - ${gF}`;
        const resultText = p.result === 'win' ? 'Victoria' : p.result === 'draw' ? 'Empate' : 'Derrota';
        resultadoHTML = `
            <div style="text-align:center;margin:20px 0;">
                <div style="font-size:48px;font-weight:700;">${marcador}</div>
                <div style="color:#059669;font-weight:600;">${resultText}</div>
            </div>
        `;
    } else {
        resultadoHTML = `<div style="text-align:center;margin:20px 0;color:#9ca3af;">Partido pendiente</div>`;
    }
    
    // Convocados
    const convocados = p.convocados || [];
    const titulares = p.titulares || [];
    const suplentes = p.suplentes || [];
    
    let convocadosHTML = '<p style="color:#9ca3af;">No hay convocados</p>';
    if (convocados.length > 0) {
        convocadosHTML = `
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;">
                ${convocados.sort((a,b) => (a.shirt_number || 99) - (b.shirt_number || 99)).map(j => `
                    <div style="display:flex;align-items:center;gap:8px;padding:8px;background:#f0fdf4;border-radius:8px;">
                        <span style="background:#059669;color:white;width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">${j.shirt_number || '-'}</span>
                        <span style="font-size:12px;">${j.name}</span>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    let titularesHTML = '<p style="color:#9ca3af;">No hay titulares</p>';
    if (titulares.length > 0) {
        titularesHTML = `
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;">
                ${titulares.sort((a,b) => (a.shirt_number || 99) - (b.shirt_number || 99)).map(j => `
                    <div style="display:flex;align-items:center;gap:8px;padding:8px;background:#dbeafe;border-radius:8px;">
                        <span style="background:#3b82f6;color:white;width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">${j.shirt_number || '-'}</span>
                        <span style="font-size:12px;">${j.name}</span>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    let suplentesHTML = '';
    if (suplentes.length > 0) {
        suplentesHTML = `
            <div style="margin-top:15px;">
                <h4 style="font-size:13px;color:#6b7280;margin-bottom:10px;">Suplentes (${suplentes.length})</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;">
                    ${suplentes.sort((a,b) => (a.shirt_number || 99) - (b.shirt_number || 99)).map(j => `
                        <div style="display:flex;align-items:center;gap:8px;padding:8px;background:#f3f4f6;border-radius:8px;">
                            <span style="background:#6b7280;color:white;width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">${j.shirt_number || '-'}</span>
                            <span style="font-size:12px;">${j.name}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Crear modal dinámico
    const modalHTML = `
        <div id="modal-ver-partido" class="modal-overlay" onclick="cerrarModalVerPartido(event)">
            <div class="modal-content" style="max-width:700px;" onclick="event.stopPropagation()">
                <div class="modal-header" style="background:linear-gradient(135deg,#059669,#047857);color:white;">
                    <div>
                        <h3 style="margin:0;">${esLocal ? (club?.name || 'Mi Equipo') : p.opponent} vs ${esLocal ? p.opponent : (club?.name || 'Mi Equipo')}</h3>
                        <p style="margin:5px 0 0;font-size:13px;opacity:0.9;">${p.competition || 'Partido'} • ${fecha} ${hora ? '• ' + hora : ''}</p>
                    </div>
                    <button class="modal-close" onclick="cerrarModalVerPartido()" style="color:white;">&times;</button>
                </div>
                <div class="modal-body">
                    ${resultadoHTML}
                    
                    <div style="margin-bottom:20px;">
                        <h4 style="font-size:14px;color:#374151;margin-bottom:10px;">📍 Información</h4>
                        <div style="background:#f8fafc;padding:15px;border-radius:10px;font-size:13px;">
                            ${p.stadium ? `<p style="margin:0 0 5px;"><strong>Estadio:</strong> ${p.stadium}</p>` : ''}
                            ${p.round ? `<p style="margin:0 0 5px;"><strong>Jornada:</strong> ${p.round}</p>` : ''}
                            ${p.lugar_encuentro ? `<p style="margin:0 0 5px;"><strong>Citación:</strong> ${p.lugar_encuentro} ${p.hora_salida ? 'a las ' + p.hora_salida : ''}</p>` : ''}
                            ${p.notas_convocatoria ? `<p style="margin:0;"><strong>Notas:</strong> ${p.notas_convocatoria}</p>` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <h4 style="font-size:14px;color:#374151;margin-bottom:10px;">⚽ Titulares (${titulares.length})</h4>
                        ${titularesHTML}
                        ${suplentesHTML}
                    </div>
                    
                    <div>
                        <h4 style="font-size:14px;color:#374151;margin-bottom:10px;">📋 Convocados (${convocados.length})</h4>
                        ${convocadosHTML}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="generarPDFConvocatoriaDesdeVer('${partidoId}')">📋 PDF Convocatoria</button>
                    <button class="btn-secondary" onclick="exportarPartidoPDF('${partidoId}')">📄 PDF Partido</button>
                    <button class="btn-primary green" onclick="cerrarModalVerPartido(); editarPartido('${partidoId}');">Editar</button>
                </div>
            </div>
        </div>
    `;
    
    // Insertar modal
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function cerrarModalVerPartido(event) {
    if (event && event.target !== event.currentTarget) return;
    const modal = document.getElementById('modal-ver-partido');
    if (modal) modal.remove();
}

async function generarPDFConvocatoriaDesdeVer(partidoId) {
    // Cargar datos del partido y generar PDF
    const { data: p } = await supabase.from('matches').select('*').eq('id', partidoId).single();
    if (!p) return;
    
    // Cargar en el formulario temporalmente para usar la función existente
    document.getElementById('partido-id').value = p.id;
    document.getElementById('partido-rival').value = p.opponent || '';
    document.getElementById('partido-competicion').value = p.competition || '';
    document.getElementById('partido-fecha').value = p.match_date || '';
    document.getElementById('partido-hora').value = p.kick_off_time || '';
    document.getElementById('partido-localidad').value = p.home_away || 'home';
    document.getElementById('partido-estadio').value = p.stadium || '';
    document.getElementById('partido-lugar-encuentro').value = p.lugar_encuentro || '';
    document.getElementById('partido-hora-salida').value = p.hora_salida || '';
    document.getElementById('partido-fecha-salida').value = p.fecha_salida || '';
    document.getElementById('partido-notas-convocatoria').value = p.notas_convocatoria || '';
    
    // Cargar convocados y titulares
    plantillaPartido = await cargarPlantillaParaPDF();
    convocadosPartido = (p.convocados || []).map(c => String(c.id));
    titularesPartido = (p.titulares || []).map(t => String(t.id));
    
    await generarPDFConvocatoria();
}

async function cargarPlantillaParaPDF() {
    const { data } = await supabase
        .from('season_players')
        .select('id, player_id, shirt_number, players(id, name, position)')
        .eq('season_id', seasonId)
        .order('shirt_number');
    return data || [];
}
        function editarPartido(id) {
            abrirModalPartido(id);
        }
        
     
        
       async function cargarConvocatoria() {
    const grid = document.getElementById('convocatoria-grid');
    
    if (!seasonId) {
        grid.innerHTML = '<p style="color:#9ca3af;">No hay temporada activa seleccionada</p>';
        return;
    }
    
    try {
        const { data, error } = await supabase
            .from('season_players')
            .select('id, player_id, shirt_number, players(id, name, position)')
            .eq('season_id', seasonId)
            .order('shirt_number');
        
        if (error) {
            console.error('Error cargando convocatoria:', error);
            grid.innerHTML = '<p style="color:#dc2626;">Error al cargar jugadores</p>';
            return;
        }
        
        plantillaPartido = data || [];
        
        if (plantillaPartido.length === 0) {
            grid.innerHTML = '<p style="color:#9ca3af;">No hay jugadores en la plantilla de esta temporada</p>';
            return;
        }
        
        renderizarConvocatoria();
        
    } catch (err) {
        console.error('Error:', err);
        grid.innerHTML = '<p style="color:#dc2626;">Error de conexión</p>';
    }
}

function renderizarConvocatoria() {
            const grid = document.getElementById('convocatoria-grid');
            
            grid.innerHTML = plantillaPartido.map(sp => {
                const j = sp.players;
                if (!j) return '';
                const seleccionado = convocadosPartido.includes(String(sp.id));
                return `
                    <div class="jugador-check ${seleccionado ? 'selected' : ''}" data-sp-id="${sp.id}" onclick="toggleConvocado('${sp.id}')">
                        <div class="jugador-check-info">
                            <div class="nombre">${j.name}</div>
                            <div class="posicion">${sp.players?.position || ''}</div>
                        </div>
                        <div class="dorsal">${sp.shirt_number || '-'}</div>
                    </div>
                `;
            }).join('');
            
            actualizarContadorConvocados();
            renderizarAlineacion();
        }
        
     function toggleConvocado(spId) {
    spId = String(spId); // Asegurar que es string
    const idx = convocadosPartido.indexOf(spId);
    if (idx > -1) {
        convocadosPartido.splice(idx, 1);
        // También quitar de titulares si estaba
        const idxTit = titularesPartido.indexOf(spId);
        if (idxTit > -1) titularesPartido.splice(idxTit, 1);
    } else {
        convocadosPartido.push(spId);
    }
    renderizarConvocatoria();
}
        
        function actualizarContadorConvocados() {
            document.getElementById('contador-convocados').textContent = `${convocadosPartido.length} convocados`;
        }
        
       function renderizarAlineacion() {
    const grid = document.getElementById('alineacion-grid');
    const contadorTitulares = document.getElementById('contador-titulares');
    const formatoEl = document.getElementById('partido-formato');
    
    if (!grid) {
        console.log('Grid de alineación no encontrado');
        return;
    }
    
    const formato = formatoEl ? (parseInt(formatoEl.value) || 11) : 11;
    
    // Actualizar contador directamente
    if (contadorTitulares) {
        contadorTitulares.textContent = `${titularesPartido.length}/${formato} titulares`;
    }
    
    const convocados = plantillaPartido.filter(sp => convocadosPartido.includes(String(sp.id)));
    
    if (convocados.length === 0) {
        grid.innerHTML = '<p style="color:#9ca3af;font-size:13px;">Primero selecciona los convocados</p>';
        return;
    }
    
    grid.innerHTML = convocados.map(sp => {
        const j = sp.players;
        if (!j) return '';
        const esTitular = titularesPartido.includes(String(sp.id));
        return `
            <div class="jugador-titular ${esTitular ? 'es-titular' : ''}" data-sp-id="${sp.id}" onclick="toggleTitular('${sp.id}')">
                <div class="dorsal">${sp.shirt_number || '-'}</div>
                <div class="nombre">${j.name}</div>
            </div>
        `;
    }).join('');
}
    

      function toggleTitular(spId) {
    spId = String(spId); // Asegurar que es string
    const formato = parseInt(document.getElementById('partido-formato').value) || 11;
    const idx = titularesPartido.indexOf(spId);
    
    if (idx > -1) {
        titularesPartido.splice(idx, 1);
    } else {
        if (titularesPartido.length >= formato) {
            alert(`Máximo ${formato} titulares para este formato`);
            return;
        }
        titularesPartido.push(spId);
    }
    renderizarAlineacion();
}
        function actualizarContadorTitulares() {
            const formato = parseInt(document.getElementById('partido-formato').value) || 11;
            document.getElementById('contador-titulares').textContent = `${titularesPartido.length}/${formato} titulares`;
        }
        // Evento para actualizar al cambiar formato
        document.addEventListener('DOMContentLoaded', function() {
            const formatoSelect = document.getElementById('partido-formato');
            if (formatoSelect) {
                formatoSelect.addEventListener('change', function() {
                    const nuevoFormato = parseInt(this.value);
                    // Si hay más titulares que el nuevo formato, recortar
                    if (titularesPartido.length > nuevoFormato) {
                        titularesPartido = titularesPartido.slice(0, nuevoFormato);
                    }
                    renderizarAlineacion();
                });
            }
        });
        function cerrarModalPartido(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modal-partido').style.display = 'none';
        }
        
     async function guardarPartido() {
            const rival = document.getElementById('partido-rival').value.trim();
            const fecha = document.getElementById('partido-fecha').value;
            
            if (!rival || !fecha) {
                alert('Rival y fecha son obligatorios');
                return;
            }
            
            // Obtener datos de convocados para guardar
     const convocadosData = plantillaPartido
    .filter(sp => convocadosPartido.includes(String(sp.id)))
                .map(sp => ({
                    id: sp.id,
                    player_id: sp.player_id,
                    name: sp.players?.name || '',
                    shirt_number: sp.shirt_number,
                    position: sp.position
                }));
            
            const titularesData = plantillaPartido
    .filter(sp => titularesPartido.includes(String(sp.id)))
                .map(sp => ({
                    id: sp.id,
                    player_id: sp.player_id,
                    name: sp.players?.name || '',
                    shirt_number: sp.shirt_number,
                    position: sp.position
                }));
            
            const suplentesData = convocadosData.filter(c => !titularesPartido.includes(String(c.id)));
            
            const partidoData = {
                club_id: clubId,
                season_id: seasonId,
                opponent: rival,
                match_date: fecha,
                kick_off_time: document.getElementById('partido-hora').value || null,
                home_away: document.getElementById('partido-localidad').value,
                stadium: document.getElementById('partido-estadio').value || null,
                competition: document.getElementById('partido-competicion').value || null,
                round: document.getElementById('partido-jornada').value || null,
                formato_juego: parseInt(document.getElementById('partido-formato').value) || 11,
                lugar_encuentro: document.getElementById('partido-lugar-encuentro').value || null,
                hora_salida: document.getElementById('partido-hora-salida').value || null,
                fecha_salida: document.getElementById('partido-fecha-salida').value || null,
                notas_convocatoria: document.getElementById('partido-notas-convocatoria').value || null,
                convocados: convocadosData,
                titulares: titularesData,
                suplentes: suplentesData
            };
            console.log('Datos a guardar:', JSON.stringify(partidoData, null, 2));
            const partidoId = document.getElementById('partido-id').value;
            
           try {
    let resultado;
    if (partidoId) {
        resultado = await supabase.from('matches').update(partidoData).eq('id', partidoId);
    } else {
        resultado = await supabase.from('matches').insert(partidoData);
    }
    
    if (resultado.error) {
        console.error('Error Supabase:', resultado.error);
        alert('Error: ' + resultado.error.message);
        return;
    }
                
                cerrarModalPartido();
                cargarPartidos();
            } catch (error) {
                alert('Error al guardar: ' + error.message);
            }
        }
        
        async function eliminarPartido(id) {
            if (!confirm('¿Eliminar este partido?')) return;
            await supabase.from('match_player_stats').delete().eq('match_id', id);
            await supabase.from('matches').delete().eq('id', id);
            cargarPartidos();
        }
        
        // ========== MATCHSTATS: RESULTADO ==========
      async function abrirModalResultado(partidoId) {
    document.getElementById('resultado-partido-id').value = partidoId;
    
    const { data: p } = await supabase.from('matches').select('*').eq('id', partidoId).single();
    
    if (!p) {
        alert('Partido no encontrado');
        return;
    }
    
    document.getElementById('resultado-favor').value = p.team_goals || 0;
    document.getElementById('resultado-contra').value = p.opponent_goals || 0;
    
    // Usar los convocados guardados en el partido (ahora son objetos JSON)
    const convocados = p.convocados || [];
    const grid = document.getElementById('stats-jugadores-grid');
    
    if (convocados.length === 0) {
        grid.innerHTML = '<p style="color:#9ca3af;text-align:center;padding:20px;">No hay jugadores convocados en este partido.<br>Edita el partido primero para añadir convocados.</p>';
    } else {
        // Cargar estadísticas existentes
        const { data: statsExist } = await supabase
            .from('match_player_stats')
            .select('*')
            .eq('match_id', partidoId);
        
        const statsMap = {};
        (statsExist || []).forEach(s => statsMap[s.player_id] = s);
        
        // Ordenar por dorsal
        const convocadosOrdenados = convocados.sort((a, b) => (a.shirt_number || 99) - (b.shirt_number || 99));
        
        grid.innerHTML = convocadosOrdenados.map(j => {
            const s = statsMap[j.player_id] || {};
            const esTitular = (p.titulares || []).some(t => t.player_id === j.player_id);
            
            return `
                <div class="jugador-stats-row" data-player-id="${j.player_id}">
                    <div class="nombre">
                        <span style="display:inline-block;background:${esTitular ? '#3b82f6' : '#6b7280'};color:white;width:22px;height:22px;border-radius:6px;text-align:center;line-height:22px;font-size:11px;margin-right:8px;">${j.shirt_number || '-'}</span>
                        ${j.name}
                        ${esTitular ? '<span style="font-size:10px;color:#3b82f6;margin-left:5px;">TIT</span>' : '<span style="font-size:10px;color:#9ca3af;margin-left:5px;">SUP</span>'}
                    </div>
                    <input type="number" class="stat-min" value="${s.minutes_played || 0}" min="0" max="120" placeholder="Min">
                    <input type="number" class="stat-goles" value="${s.goals || 0}" min="0" placeholder="Gol">
                    <input type="number" class="stat-asist" value="${s.assists || 0}" min="0" placeholder="Asi">
                    <input type="number" class="stat-amarillas" value="${s.yellow_cards || 0}" min="0" max="2" placeholder="TA">
                    <input type="number" class="stat-rojas" value="${s.red_cards || 0}" min="0" max="1" placeholder="TR">
                </div>
            `;
        }).join('');
    }
    
    document.getElementById('modal-resultado').style.display = 'flex';
}
        
        function cerrarModalResultado(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modal-resultado').style.display = 'none';
        }
        
     async function guardarResultado() {
    const partidoId = document.getElementById('resultado-partido-id').value;
    const gF = parseInt(document.getElementById('resultado-favor').value) || 0;
    const gC = parseInt(document.getElementById('resultado-contra').value) || 0;
    
    let resultado = 'draw';
    if (gF > gC) resultado = 'win';
    else if (gF < gC) resultado = 'loss';
    
    // Actualizar resultado del partido
    const { error: errorPartido } = await supabase.from('matches').update({
        team_goals: gF,
        opponent_goals: gC,
        result: resultado
    }).eq('id', partidoId);
    
    if (errorPartido) {
        alert('Error al guardar resultado: ' + errorPartido.message);
        return;
    }
    
    // Guardar estadísticas de cada jugador
    const rows = document.querySelectorAll('.jugador-stats-row');
    let errores = [];
    
    for (const row of rows) {
        const playerId = row.dataset.playerId;
        const minutos = parseInt(row.querySelector('.stat-min').value) || 0;
        const goles = parseInt(row.querySelector('.stat-goles').value) || 0;
        const asistencias = parseInt(row.querySelector('.stat-asist').value) || 0;
        const amarillas = parseInt(row.querySelector('.stat-amarillas').value) || 0;
        const rojas = parseInt(row.querySelector('.stat-rojas').value) || 0;
        
        // Verificar si ya existe un registro para este jugador en este partido
        const { data: existente } = await supabase
            .from('match_player_stats')
            .select('id')
            .eq('match_id', partidoId)
            .eq('player_id', playerId)
            .single();
        
        if (existente) {
            // Actualizar registro existente
            const { error } = await supabase
                .from('match_player_stats')
                .update({
                    minutes_played: minutos,
                    goals: goles,
                    assists: asistencias,
                    yellow_cards: amarillas,
                    red_cards: rojas
                })
                .eq('id', existente.id);
            
            if (error) errores.push(error.message);
        } else {
            // Crear nuevo registro
            const { error } = await supabase
                .from('match_player_stats')
                .insert({
                    match_id: partidoId,
                    player_id: playerId,
                    minutes_played: minutos,
                    goals: goles,
                    assists: asistencias,
                    yellow_cards: amarillas,
                    red_cards: rojas
                });
            
            if (error) errores.push(error.message);
        }
    }
    
    if (errores.length > 0) {
        console.error('Errores al guardar stats:', errores);
        alert('Algunos datos no se guardaron correctamente');
    } else {
        alert('Resultado y estadísticas guardados correctamente');
    }
    
    cerrarModalResultado();
    cargarPartidos();
}
        
        // ========== MATCHSTATS: ESTADÍSTICAS ==========
        async function cargarSelectorTemporadasStats() {
            const select = document.getElementById('stats-temporada');
            const { data } = await supabase.from('seasons').select('*').eq('club_id', clubId).order('start_date', { ascending: false });
            
            select.innerHTML = (data || []).map(t => {
                const selected = t.id === seasonId ? 'selected' : '';
                return `<option value="${t.id}" ${selected}>${t.name}</option>`;
            }).join('');
        }
        
        async function cargarEstadisticas() {
            const tempId = document.getElementById('stats-temporada').value || seasonId;
            const resumenDiv = document.getElementById('stats-resumen');
            const tablaBody = document.getElementById('stats-tabla-body');
            
            // Resumen partidos
            const { data: partidos } = await supabase.from('matches').select('*').eq('season_id', tempId).not('result', 'is', null);
            
            const victorias = partidos?.filter(p => p.result === 'win').length || 0;
            const empates = partidos?.filter(p => p.result === 'draw').length || 0;
            const derrotas = partidos?.filter(p => p.result === 'loss').length || 0;
            const gF = partidos?.reduce((sum, p) => sum + (p.team_goals || 0), 0) || 0;
            const gC = partidos?.reduce((sum, p) => sum + (p.opponent_goals || 0), 0) || 0;
            
            resumenDiv.innerHTML = `
                <div class="stat-card victoria"><div class="valor">${victorias}</div><div class="label">Victorias</div></div>
                <div class="stat-card empate"><div class="valor">${empates}</div><div class="label">Empates</div></div>
                <div class="stat-card derrota"><div class="valor">${derrotas}</div><div class="label">Derrotas</div></div>
                <div class="stat-card"><div class="valor">${gF}</div><div class="label">Goles a favor</div></div>
                <div class="stat-card"><div class="valor">${gC}</div><div class="label">Goles en contra</div></div>
            `;
            
            // Stats por jugador
            const { data: stats } = await supabase
                .from('match_player_stats')
                .select('*, players(id, name, position, photo_url), matches!inner(season_id)')
                .eq('matches.season_id', tempId);
            
            const jugadorStats = {};
            (stats || []).forEach(s => {
                const pid = s.player_id;
                if (!jugadorStats[pid]) {
                    jugadorStats[pid] = { player: s.players, pj: 0, min: 0, goles: 0, asist: 0, ta: 0, tr: 0 };
                }
                if (s.minutes_played > 0) jugadorStats[pid].pj++;
                jugadorStats[pid].min += s.minutes_played || 0;
                jugadorStats[pid].goles += s.goals || 0;
                jugadorStats[pid].asist += s.assists || 0;
                jugadorStats[pid].ta += s.yellow_cards || 0;
                jugadorStats[pid].tr += s.red_cards || 0;
            });
            
            const ordenados = Object.values(jugadorStats).sort((a, b) => b.goles - a.goles);
            
            if (ordenados.length === 0) {
                tablaBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#9ca3af;">No hay estadisticas</td></tr>';
            } else {
               tablaBody.innerHTML = ordenados.map(j => {
    const inicial = j.player?.name?.charAt(0) || '?';
    const playerId = j.player?.id;
    return `
        <tr onclick="abrirFichaJugador('${playerId}')" style="cursor: pointer;" title="Ver ficha completa">
            <td>
                <div class="jugador-cell">
                    <div class="jugador-mini-foto">
                        ${j.player?.photo_url ? `<img src="${j.player.photo_url}">` : inicial}
                    </div>
                    <div>
                        <strong>${j.player?.name || 'Sin nombre'}</strong>
                        <div style="font-size:12px;color:#6b7280;">${j.player?.position || ''}</div>
                    </div>
                </div>
            </td>
            <td>${j.pj}</td>
            <td>${j.min}</td>
            <td><strong>${j.goles}</strong></td>
            <td>${j.asist}</td>
            <td>${j.ta}</td>
            <td>${j.tr}</td>
        </tr>
    `;
}).join('');
            }
        }
        // ========== FICHA JUGADOR ==========
let fichaJugadorActual = null;

async function abrirFichaJugador(playerId) {
    if (!playerId) return;
    
    fichaJugadorActual = playerId;
    const tempId = document.getElementById('stats-temporada').value || seasonId;
    
    // Cargar datos del jugador
    const { data: jugador } = await supabase
        .from('players')
        .select('*')
        .eq('id', playerId)
        .single();
    
    if (!jugador) {
        alert('Jugador no encontrado');
        return;
    }
    
    // Actualizar header del modal
    const fotoDiv = document.getElementById('ficha-foto');
    if (jugador.photo_url) {
        fotoDiv.innerHTML = `<img src="${jugador.photo_url}" style="width:100%;height:100%;object-fit:cover;">`;
    } else {
        fotoDiv.innerHTML = jugador.name?.charAt(0) || '?';
    }
    document.getElementById('ficha-nombre').textContent = jugador.name || 'Sin nombre';
    document.getElementById('ficha-posicion').textContent = jugador.position || 'Sin posición';
    
    // Datos personales
    const datosDiv = document.getElementById('ficha-datos-personales');
    const edad = jugador.birth_date ? calcularEdad(jugador.birth_date) : null;
    datosDiv.innerHTML = `
        ${jugador.birth_date ? `<div><strong>Edad:</strong> ${edad} años</div>` : ''}
        ${jugador.height_cm ? `<div><strong>Altura:</strong> ${jugador.height_cm} cm</div>` : ''}
        ${jugador.weight_kg ? `<div><strong>Peso:</strong> ${jugador.weight_kg} kg</div>` : ''}
        ${jugador.dominant_foot ? `<div><strong>Pie:</strong> ${jugador.dominant_foot}</div>` : ''}
        ${jugador.phone ? `<div><strong>Tel:</strong> ${jugador.phone}</div>` : ''}
        ${jugador.email ? `<div><strong>Email:</strong> ${jugador.email}</div>` : ''}
    `;
    
    // Cargar estadísticas del jugador en la temporada
    const { data: stats } = await supabase
        .from('match_player_stats')
        .select('*, matches!inner(id, opponent, match_date, home_away, team_goals, opponent_goals, result, season_id)')
        .eq('player_id', playerId)
        .eq('matches.season_id', tempId)
        .order('matches(match_date)', { ascending: false });
    
    // Calcular resumen
    let totalPJ = 0, totalMin = 0, totalGoles = 0, totalAsist = 0, totalTA = 0, totalTR = 0;
    (stats || []).forEach(s => {
        if (s.minutes_played > 0) totalPJ++;
        totalMin += s.minutes_played || 0;
        totalGoles += s.goals || 0;
        totalAsist += s.assists || 0;
        totalTA += s.yellow_cards || 0;
        totalTR += s.red_cards || 0;
    });
    
    // Mostrar resumen
    document.getElementById('ficha-stats-resumen').innerHTML = `
        <div style="text-align:center;padding:15px;background:#ecfdf5;border-radius:10px;">
            <div style="font-size:28px;font-weight:700;color:#059669;">${totalPJ}</div>
            <div style="font-size:12px;color:#6b7280;">Partidos</div>
        </div>
        <div style="text-align:center;padding:15px;background:#eff6ff;border-radius:10px;">
            <div style="font-size:28px;font-weight:700;color:#3b82f6;">${totalMin}</div>
            <div style="font-size:12px;color:#6b7280;">Minutos</div>
        </div>
        <div style="text-align:center;padding:15px;background:#fef3c7;border-radius:10px;">
            <div style="font-size:28px;font-weight:700;color:#d97706;">${totalGoles}</div>
            <div style="font-size:12px;color:#6b7280;">Goles</div>
        </div>
        <div style="text-align:center;padding:15px;background:#f3e8ff;border-radius:10px;">
            <div style="font-size:28px;font-weight:700;color:#9333ea;">${totalAsist}</div>
            <div style="font-size:12px;color:#6b7280;">Asistencias</div>
        </div>
        <div style="text-align:center;padding:15px;background:#fef2f2;border-radius:10px;">
            <div style="font-size:28px;font-weight:700;color:#ef4444;">${totalTA}</div>
            <div style="font-size:12px;color:#6b7280;">Amarillas</div>
        </div>
        <div style="text-align:center;padding:15px;background:#fee2e2;border-radius:10px;">
            <div style="font-size:28px;font-weight:700;color:#dc2626;">${totalTR}</div>
            <div style="font-size:12px;color:#6b7280;">Rojas</div>
        </div>
    `;
    
    // Mostrar detalle partido a partido
    const tbody = document.getElementById('ficha-partidos-body');
    if (!stats || stats.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#9ca3af;padding:20px;">No hay partidos registrados</td></tr>';
    } else {
        tbody.innerHTML = stats.map(s => {
            const m = s.matches;
            const fecha = new Date(m.match_date).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
            const esLocal = m.home_away === 'home';
            const marcador = esLocal ? `${m.team_goals || 0}-${m.opponent_goals || 0}` : `${m.opponent_goals || 0}-${m.team_goals || 0}`;
            
            let resultadoClass = '';
            let resultadoTexto = marcador;
            if (m.result === 'win') resultadoClass = 'color:#059669;font-weight:600;';
            else if (m.result === 'loss') resultadoClass = 'color:#dc2626;font-weight:600;';
            else if (m.result === 'draw') resultadoClass = 'color:#d97706;';
            
            return `
                <tr>
                    <td>${fecha}</td>
                    <td>${esLocal ? 'vs ' : '@ '}${m.opponent}</td>
                    <td style="${resultadoClass}">${resultadoTexto}</td>
                    <td>${s.minutes_played || 0}'</td>
                    <td><strong>${s.goals || 0}</strong></td>
                    <td>${s.assists || 0}</td>
                    <td>${s.yellow_cards || 0}</td>
                    <td>${s.red_cards || 0}</td>
                </tr>
            `;
        }).join('');
    }
    
    document.getElementById('modal-ficha-jugador').style.display = 'flex';
}

function calcularEdad(fechaNacimiento) {
    const hoy = new Date();
    const nacimiento = new Date(fechaNacimiento);
    let edad = hoy.getFullYear() - nacimiento.getFullYear();
    const mes = hoy.getMonth() - nacimiento.getMonth();
    if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
        edad--;
    }
    return edad;
}

function cerrarModalFichaJugador(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('modal-ficha-jugador').style.display = 'none';
}

async function exportarFichaJugadorPDF() {
    if (!fichaJugadorActual) return;
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const tempId = document.getElementById('stats-temporada').value || seasonId;
    
    // Cargar datos
    const { data: jugador } = await supabase.from('players').select('*').eq('id', fichaJugadorActual).single();
    const { data: club } = await supabase.from('clubs').select('name, logo_url').eq('id', clubId).single();
    const { data: temporada } = await supabase.from('seasons').select('name').eq('id', tempId).single();
    const { data: stats } = await supabase
        .from('match_player_stats')
        .select('*, matches!inner(opponent, match_date, home_away, team_goals, opponent_goals, result, season_id)')
        .eq('player_id', fichaJugadorActual)
        .eq('matches.season_id', tempId)
        .order('matches(match_date)', { ascending: false });
    
    // Calcular totales
    let totalPJ = 0, totalMin = 0, totalGoles = 0, totalAsist = 0, totalTA = 0, totalTR = 0;
    (stats || []).forEach(s => {
        if (s.minutes_played > 0) totalPJ++;
        totalMin += s.minutes_played || 0;
        totalGoles += s.goals || 0;
        totalAsist += s.assists || 0;
        totalTA += s.yellow_cards || 0;
        totalTR += s.red_cards || 0;
    });
    
    // ===== HEADER =====
    doc.setFillColor(31, 41, 55);
    doc.rect(0, 0, 210, 50, 'F');
    
    // Foto del jugador (placeholder circular)
    doc.setFillColor(107, 114, 128);
    doc.circle(30, 25, 15, 'F');
    if (jugador.photo_url) {
        try {
            doc.addImage(jugador.photo_url, 'JPEG', 15, 10, 30, 30);
        } catch (e) {
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.text(jugador.name?.charAt(0) || '?', 30, 28, { align: 'center' });
        }
    } else {
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.text(jugador.name?.charAt(0) || '?', 30, 28, { align: 'center' });
    }
    
    // Nombre y posición
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(22);
    doc.setFont('helvetica', 'bold');
    doc.text(jugador.name || 'Sin nombre', 55, 20);
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.text(jugador.position || '', 55, 30);
    doc.setFontSize(10);
    doc.text(`${club?.name || 'Mi Club'} - ${temporada?.name || 'Temporada'}`, 55, 40);
    
    // Escudo del club
    if (club?.logo_url) {
        try {
            doc.addImage(club.logo_url, 'PNG', 175, 10, 25, 25);
        } catch (e) {}
    }
    
    let y = 60;
    
    // ===== DATOS PERSONALES =====
    doc.setTextColor(30, 30, 30);
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('DATOS PERSONALES', 15, y);
    y += 8;
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    const edad = jugador.birth_date ? calcularEdad(jugador.birth_date) : null;
    let datosLinea = [];
    if (edad) datosLinea.push(`Edad: ${edad} años`);
    if (jugador.height_cm) datosLinea.push(`Altura: ${jugador.height_cm} cm`);
    if (jugador.weight_kg) datosLinea.push(`Peso: ${jugador.weight_kg} kg`);
    if (jugador.dominant_foot) datosLinea.push(`Pie: ${jugador.dominant_foot}`);
    doc.text(datosLinea.join('   |   '), 15, y);
    y += 15;
    
    // ===== RESUMEN ESTADÍSTICAS =====
    doc.setFillColor(240, 240, 240);
    doc.rect(15, y - 5, 180, 25, 'F');
    
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(30, 30, 30);
    doc.text('RESUMEN DE TEMPORADA', 15, y + 2);
    y += 12;
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`PJ: ${totalPJ}   |   Min: ${totalMin}   |   Goles: ${totalGoles}   |   Asist: ${totalAsist}   |   TA: ${totalTA}   |   TR: ${totalTR}`, 15, y + 2);
    y += 20;
    
    // ===== DETALLE PARTIDOS =====
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('PARTICIPACION POR PARTIDO', 15, y);
    y += 8;
    
    if (stats && stats.length > 0) {
        const tableData = stats.map(s => {
            const m = s.matches;
            const fecha = new Date(m.match_date).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
            const esLocal = m.home_away === 'home';
            const marcador = esLocal ? `${m.team_goals || 0}-${m.opponent_goals || 0}` : `${m.opponent_goals || 0}-${m.team_goals || 0}`;
            return [
                fecha,
                (esLocal ? 'vs ' : '@ ') + m.opponent,
                marcador,
                s.minutes_played || 0,
                s.goals || 0,
                s.assists || 0,
                s.yellow_cards || 0,
                s.red_cards || 0
            ];
        });
        
        doc.autoTable({
            startY: y,
            head: [['Fecha', 'Rival', 'Res', 'Min', 'Gol', 'Asi', 'TA', 'TR']],
            body: tableData,
            theme: 'striped',
            headStyles: { fillColor: [31, 41, 55], fontSize: 9 },
            styles: { fontSize: 9, cellPadding: 3 },
            columnStyles: {
                0: { cellWidth: 22 },
                1: { cellWidth: 50 },
                2: { cellWidth: 18 },
                3: { cellWidth: 18 },
                4: { cellWidth: 18 },
                5: { cellWidth: 18 },
                6: { cellWidth: 18 },
                7: { cellWidth: 18 }
            }
        });
    } else {
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(150, 150, 150);
        doc.text('No hay partidos registrados en esta temporada', 105, y + 10, { align: 'center' });
    }
    
    // ===== FOOTER =====
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text('Generado con TopLiderCoach.com', 105, 285, { align: 'center' });
    
    // Guardar
    const nombreArchivo = `ficha_${jugador.name?.replace(/\s+/g, '_') || 'jugador'}.pdf`;
    doc.save(nombreArchivo);
}
        // ========== PDF EXPORTS ==========
     // ========== PDF CONVOCATORIA ==========
async function generarPDFConvocatoria() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Obtener datos del formulario
    const rival = document.getElementById('partido-rival').value || 'Rival';
    const fecha = document.getElementById('partido-fecha').value;
    const hora = document.getElementById('partido-hora').value || '';
    const estadio = document.getElementById('partido-estadio').value || '';
    const localidad = document.getElementById('partido-localidad').value;
    const competicion = document.getElementById('partido-competicion').value || '';
    const lugarEncuentro = document.getElementById('partido-lugar-encuentro').value || '';
    const horaSalida = document.getElementById('partido-hora-salida').value || '';
    const fechaSalida = document.getElementById('partido-fecha-salida').value || '';
    const notas = document.getElementById('partido-notas-convocatoria').value || '';
    
    // Obtener datos del club
    const { data: club } = await supabase.from('clubs').select('name, logo_url').eq('id', clubId).single();
    
    // Formatear fecha
    const fechaFormateada = fecha ? new Date(fecha).toLocaleDateString('es-ES', { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric' 
    }) : '';
    
    // ===== HEADER =====
    doc.setFillColor(5, 150, 105); // Verde
    doc.rect(0, 0, 210, 40, 'F');
    
    // Escudo del club
    let tituloX = 15;
    if (club && club.logo_url) {
        try {
            doc.addImage(club.logo_url, 'PNG', 12, 5, 30, 30);
            tituloX = 50;
        } catch (e) {
            console.log('No se pudo cargar el escudo');
        }
    }
    
    // Título
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(22);
    doc.setFont('helvetica', 'bold');
    doc.text('CONVOCATORIA', tituloX, 18);
    
    // Nombre del club
    if (club && club.name) {
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text(club.name, tituloX, 28);
    }
    
    // Competición
    if (competicion) {
        doc.setFontSize(10);
        doc.text(competicion, tituloX, 35);
    }
    
    let y = 55;
    
    // ===== DATOS DEL PARTIDO =====
    doc.setFillColor(240, 240, 240);
    doc.rect(15, y - 5, 180, 35, 'F');
    
    doc.setTextColor(30, 30, 30);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('PARTIDO', 20, y + 2);
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    
    const esLocal = localidad === 'home';
    const textoPartido = esLocal 
        ? `${club?.name || 'Mi Equipo'}  vs  ${rival}`
        : `${rival}  vs  ${club?.name || 'Mi Equipo'}`;
    
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text(textoPartido, 105, y + 12, { align: 'center' });
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(80, 80, 80);
    
    let infoPartido = [];
    if (fechaFormateada) infoPartido.push(fechaFormateada);
    if (hora) infoPartido.push(hora + 'h');
    doc.text(infoPartido.join('  •  '), 105, y + 22, { align: 'center' });
    
    if (estadio) {
        doc.text(estadio, 105, y + 28, { align: 'center' });
    }
    
    y += 45;
    
    // ===== DATOS DE CITACIÓN =====
    if (lugarEncuentro || horaSalida) {
        doc.setFillColor(255, 243, 205); // Amarillo claro
        doc.rect(15, y - 5, 180, 22, 'F');
        
        doc.setTextColor(180, 83, 9);
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.text('CITACION', 20, y + 2);
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        doc.setTextColor(80, 80, 80);
        
       let infoCitacion = [];
if (lugarEncuentro) infoCitacion.push(`Lugar: ${lugarEncuentro}`);
if (fechaSalida) {
    const fechaSalidaFormateada = new Date(fechaSalida).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
    infoCitacion.push(`Fecha: ${fechaSalidaFormateada}`);
}
if (horaSalida) infoCitacion.push(`Hora: ${horaSalida}h`);
        doc.text(infoCitacion.join('     |     '), 105, y + 12, { align: 'center' });
        
        y += 28;
    }
    
    // ===== JUGADORES CONVOCADOS =====
    y += 5;
    doc.setFillColor(5, 150, 105);
    doc.rect(15, y - 5, 180, 10, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text(`JUGADORES CONVOCADOS (${convocadosPartido.length})`, 20, y + 2);
    
    y += 12;
    
    // Lista de convocados
    const convocados = plantillaPartido
        .filter(sp => convocadosPartido.includes(sp.id))
        .sort((a, b) => (a.shirt_number || 99) - (b.shirt_number || 99));
    
    if (convocados.length === 0) {
        doc.setTextColor(150, 150, 150);
        doc.setFontSize(10);
        doc.text('No hay jugadores convocados', 105, y + 10, { align: 'center' });
        y += 20;
    } else {
        // Mostrar en 2 columnas
        const mitad = Math.ceil(convocados.length / 2);
        const columna1 = convocados.slice(0, mitad);
        const columna2 = convocados.slice(mitad);
        
        doc.setTextColor(30, 30, 30);
        doc.setFontSize(11);
        
        const col1X = 25;
        const col2X = 115;
        let maxY = y;
        
        columna1.forEach((sp, idx) => {
            const jugador = sp.players;
            if (!jugador) return;
            
            // Fondo alternado
            if (idx % 2 === 0) {
                doc.setFillColor(248, 250, 252);
                doc.rect(15, y - 4, 85, 12, 'F');
            }
            
            // Dorsal
            doc.setFillColor(31, 41, 55);
            doc.roundedRect(col1X, y - 3, 10, 10, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text(String(sp.shirt_number || '-'), col1X + 5, y + 4, { align: 'center' });
            
            // Nombre
            doc.setTextColor(30, 30, 30);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(jugador.name || 'Sin nombre', col1X + 15, y + 4);
            
            y += 12;
        });
        
        maxY = y;
        y = maxY - (columna1.length * 12); // Volver arriba para columna 2
        
        columna2.forEach((sp, idx) => {
            const jugador = sp.players;
            if (!jugador) return;
            
            // Fondo alternado
            if (idx % 2 === 0) {
                doc.setFillColor(248, 250, 252);
                doc.rect(105, y - 4, 85, 12, 'F');
            }
            
            // Dorsal
            doc.setFillColor(31, 41, 55);
            doc.roundedRect(col2X, y - 3, 10, 10, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text(String(sp.shirt_number || '-'), col2X + 5, y + 4, { align: 'center' });
            
            // Nombre
            doc.setTextColor(30, 30, 30);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(jugador.name || 'Sin nombre', col2X + 15, y + 4);
            
            y += 12;
        });
        
        y = Math.max(maxY, y) + 5;
    }
    
    // ===== NOTAS =====
    if (notas) {
        y += 5;
        doc.setFillColor(254, 249, 195); // Amarillo muy claro
        const notasLines = doc.splitTextToSize(notas, 170);
        const alturaNotas = 15 + (notasLines.length * 5);
        doc.rect(15, y - 5, 180, alturaNotas, 'F');
        
        doc.setTextColor(133, 77, 14);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text('NOTAS:', 20, y + 3);
        
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(80, 80, 80);
        doc.text(notasLines, 20, y + 12);
    }
    
    // ===== FOOTER =====
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text('Generado con TopLiderCoach.com', 105, 287, { align: 'center' });
    
    // Guardar
    const nombreArchivo = `convocatoria_${rival.replace(/\s+/g, '_')}_${fecha}.pdf`;
    doc.save(nombreArchivo);
}
async function generarPDFAlineacion() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Obtener datos del formulario
    const rival = document.getElementById('partido-rival').value || 'Rival';
    const fecha = document.getElementById('partido-fecha').value;
    const hora = document.getElementById('partido-hora').value || '';
    const estadio = document.getElementById('partido-estadio').value || '';
    const localidad = document.getElementById('partido-localidad').value;
    const competicion = document.getElementById('partido-competicion').value || '';
    const jornada = document.getElementById('partido-jornada').value || '';
    const formato = parseInt(document.getElementById('partido-formato').value) || 11;
    
    // Obtener datos del club
    const { data: club } = await supabase.from('clubs').select('name, logo_url').eq('id', clubId).single();
    
    // Formatear fecha
    const fechaFormateada = fecha ? new Date(fecha).toLocaleDateString('es-ES', { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric' 
    }) : '';
    
    // Obtener titulares y suplentes
    const titulares = plantillaPartido
        .filter(sp => titularesPartido.includes(String(sp.id)))
        .sort((a, b) => (a.shirt_number || 99) - (b.shirt_number || 99));
    
    const suplentes = plantillaPartido
        .filter(sp => convocadosPartido.includes(String(sp.id)) && !titularesPartido.includes(String(sp.id)))
        .sort((a, b) => (a.shirt_number || 99) - (b.shirt_number || 99));
    
    const esLocal = localidad === 'home';
    
    // ===== HEADER =====
    doc.setFillColor(59, 130, 246); // Azul
    doc.rect(0, 0, 210, 45, 'F');
    
    // Escudo del club
    let tituloX = 15;
    if (club && club.logo_url) {
        try {
            doc.addImage(club.logo_url, 'PNG', 12, 7, 30, 30);
            tituloX = 50;
        } catch (e) {
            console.log('No se pudo cargar el escudo');
        }
    }
    
    // Título
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(24);
    doc.setFont('helvetica', 'bold');
    doc.text('ALINEACION', tituloX, 20);
    
    // Subtítulo
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    const subtitulo = `${club?.name || 'Mi Equipo'} - ${competicion || 'Partido'}`;
    doc.text(subtitulo, tituloX, 30);
    
    // Formato
    doc.setFontSize(10);
    doc.text(`Futbol ${formato}`, tituloX, 38);
    
    let y = 55;
    
    // ===== DATOS DEL PARTIDO =====
    doc.setFillColor(240, 240, 240);
    doc.rect(15, y - 5, 180, 35, 'F');
    
    // Equipos y VS
    doc.setTextColor(30, 30, 30);
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    
    const equipoLocal = esLocal ? (club?.name || 'Mi Equipo') : rival;
    const equipoVisitante = esLocal ? rival : (club?.name || 'Mi Equipo');
    
    doc.text(equipoLocal, 50, y + 8, { align: 'center' });
    doc.text('VS', 105, y + 8, { align: 'center' });
    doc.text(equipoVisitante, 160, y + 8, { align: 'center' });
    
    // Etiquetas Local/Visitante
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(100, 100, 100);
    doc.text('LOCAL', 50, y + 16, { align: 'center' });
    doc.text('VISITANTE', 160, y + 16, { align: 'center' });
    
    // Info partido
    doc.setFontSize(10);
    doc.setTextColor(80, 80, 80);
    let infoPartido = [];
    if (fechaFormateada) infoPartido.push(fechaFormateada);
    if (hora) infoPartido.push(hora + 'h');
    if (jornada) infoPartido.push(jornada);
    doc.text(infoPartido.join('  •  '), 105, y + 25, { align: 'center' });
    
    if (estadio) {
        doc.setFontSize(9);
        doc.text(estadio, 105, y + 30, { align: 'center' });
    }
    
    y += 45;
    
    // ===== TITULARES =====
    doc.setFillColor(59, 130, 246);
    doc.rect(15, y, 180, 10, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text(`TITULARES (${titulares.length})`, 20, y + 7);
    
    y += 15;
    
    if (titulares.length === 0) {
        doc.setTextColor(150, 150, 150);
        doc.setFontSize(10);
        doc.text('No hay titulares seleccionados', 105, y + 5, { align: 'center' });
        y += 15;
    } else {
        // Mostrar titulares en 2 columnas
        const mitad = Math.ceil(titulares.length / 2);
        const col1 = titulares.slice(0, mitad);
        const col2 = titulares.slice(mitad);
        
        const col1X = 20;
        const col2X = 115;
        let maxY = y;
        
        // Columna 1
        col1.forEach((sp, idx) => {
            const jugador = sp.players;
            if (!jugador) return;
            
            // Fondo alternado
            if (idx % 2 === 0) {
                doc.setFillColor(239, 246, 255);
                doc.rect(15, y - 4, 85, 12, 'F');
            }
            
            // Dorsal
            doc.setFillColor(59, 130, 246);
            doc.roundedRect(col1X, y - 3, 12, 10, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(String(sp.shirt_number || '-'), col1X + 6, y + 4, { align: 'center' });
            
            // Nombre
            doc.setTextColor(30, 30, 30);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(jugador.name || 'Sin nombre', col1X + 17, y + 4);
            
            y += 12;
        });
        
        maxY = y;
        y = maxY - (col1.length * 12); // Volver arriba para columna 2
        
        // Columna 2
        col2.forEach((sp, idx) => {
            const jugador = sp.players;
            if (!jugador) return;
            
            // Fondo alternado
            if (idx % 2 === 0) {
                doc.setFillColor(239, 246, 255);
                doc.rect(110, y - 4, 85, 12, 'F');
            }
            
            // Dorsal
            doc.setFillColor(59, 130, 246);
            doc.roundedRect(col2X, y - 3, 12, 10, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(String(sp.shirt_number || '-'), col2X + 6, y + 4, { align: 'center' });
            
            // Nombre
            doc.setTextColor(30, 30, 30);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(jugador.name || 'Sin nombre', col2X + 17, y + 4);
            
            y += 12;
        });
        
        y = Math.max(maxY, y) + 10;
    }
    
    // ===== SUPLENTES =====
    doc.setFillColor(107, 114, 128); // Gris
    doc.rect(15, y, 180, 10, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text(`SUPLENTES (${suplentes.length})`, 20, y + 7);
    
    y += 15;
    
    if (suplentes.length === 0) {
        doc.setTextColor(150, 150, 150);
        doc.setFontSize(10);
        doc.text('No hay suplentes', 105, y + 5, { align: 'center' });
        y += 15;
    } else {
        // Mostrar suplentes en 2 columnas
        const mitad = Math.ceil(suplentes.length / 2);
        const col1 = suplentes.slice(0, mitad);
        const col2 = suplentes.slice(mitad);
        
        const col1X = 20;
        const col2X = 115;
        let maxY = y;
        
        // Columna 1
        col1.forEach((sp, idx) => {
            const jugador = sp.players;
            if (!jugador) return;
            
            // Fondo alternado
            if (idx % 2 === 0) {
                doc.setFillColor(243, 244, 246);
                doc.rect(15, y - 4, 85, 12, 'F');
            }
            
            // Dorsal
            doc.setFillColor(107, 114, 128);
            doc.roundedRect(col1X, y - 3, 12, 10, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(String(sp.shirt_number || '-'), col1X + 6, y + 4, { align: 'center' });
            
            // Nombre
            doc.setTextColor(30, 30, 30);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(jugador.name || 'Sin nombre', col1X + 17, y + 4);
            
            y += 12;
        });
        
        maxY = y;
        y = maxY - (col1.length * 12);
        
        // Columna 2
        col2.forEach((sp, idx) => {
            const jugador = sp.players;
            if (!jugador) return;
            
            // Fondo alternado
            if (idx % 2 === 0) {
                doc.setFillColor(243, 244, 246);
                doc.rect(110, y - 4, 85, 12, 'F');
            }
            
            // Dorsal
            doc.setFillColor(107, 114, 128);
            doc.roundedRect(col2X, y - 3, 12, 10, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(String(sp.shirt_number || '-'), col2X + 6, y + 4, { align: 'center' });
            
            // Nombre
            doc.setTextColor(30, 30, 30);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(jugador.name || 'Sin nombre', col2X + 17, y + 4);
            
            y += 12;
        });
        
        y = Math.max(maxY, y) + 10;
    }
    
    // ===== ESPACIO PARA NOTAS =====
    y += 5;
    doc.setDrawColor(200, 200, 200);
    doc.setFillColor(255, 255, 240);
    doc.rect(15, y, 180, 30, 'FD');
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(150, 150, 150);
    doc.text('NOTAS / TACTICA:', 18, y + 6);
    
    // Líneas para escribir
    doc.setDrawColor(220, 220, 220);
    for (let lineY = y + 12; lineY < y + 28; lineY += 7) {
        doc.line(18, lineY, 192, lineY);
    }
    
    // ===== FOOTER =====
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text('Generado con TopLiderCoach.com', 105, 287, { align: 'center' });
    
    // Guardar
    const nombreArchivo = `alineacion_${rival.replace(/\s+/g, '_')}_${fecha}.pdf`;
    doc.save(nombreArchivo);
}
        async function exportarPartidoPDF(partidoId) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const { data: p } = await supabase.from('matches').select('*').eq('id', partidoId).single();
            const { data: stats } = await supabase.from('match_player_stats').select('*, players(name, position)').eq('match_id', partidoId).order('minutes_played', { ascending: false });
            
            const fecha = new Date(p.match_date).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Header
            doc.setFillColor(5, 150, 105);
            doc.rect(0, 0, 210, 50, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('ACTA DEL PARTIDO', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text(fecha, 105, 32, { align: 'center' });
            doc.text(p.competition || 'Partido', 105, 42, { align: 'center' });
            
            // Resultado
            doc.setTextColor(30, 30, 30);
            doc.setFontSize(16);
            const esLocal = p.home_away === 'home';
            const eqLocal = esLocal ? (clubData?.name || 'Mi Equipo') : p.opponent;
            const eqVisit = esLocal ? p.opponent : (clubData?.name || 'Mi Equipo');
            const gLocal = esLocal ? (p.team_goals || 0) : (p.opponent_goals || 0);
            const gVisit = esLocal ? (p.opponent_goals || 0) : (p.team_goals || 0);
            
            doc.text(eqLocal, 50, 70, { align: 'center' });
            doc.text(eqVisit, 160, 70, { align: 'center' });
            doc.setFontSize(32);
            doc.text(`${gLocal} - ${gVisit}`, 105, 72, { align: 'center' });
            doc.setFontSize(10);
            doc.text('LOCAL', 50, 78, { align: 'center' });
            doc.text('VISITANTE', 160, 78, { align: 'center' });
            
            let y = 95;
            if (p.stadium) { doc.text(`Estadio: ${p.stadium}`, 20, y); y += 8; }
            if (p.round) { doc.text(`${p.round}`, 20, y); y += 8; }
            
            if (stats && stats.length > 0) {
                y += 10;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('ESTADISTICAS POR JUGADOR', 105, y, { align: 'center' });
                y += 10;
                
                const tableData = stats.map(s => [
                    s.players?.name || 'Sin nombre',
                    s.players?.position || '',
                    s.minutes_played || 0,
                    s.goals || 0,
                    s.assists || 0,
                    s.yellow_cards || 0,
                    s.red_cards || 0
                ]);
                
                doc.autoTable({
                    startY: y,
                    head: [['Jugador', 'Pos', 'Min', 'Goles', 'Asist', 'TA', 'TR']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: { fillColor: [5, 150, 105] },
                    styles: { fontSize: 9 }
                });
            }
            
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text('Generado con HUB TopLiderCoach', 105, 285, { align: 'center' });
            
            doc.save(`partido_${p.opponent}_${p.match_date}.pdf`);
        }
        
        async function exportarEstadisticasPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const tempId = document.getElementById('stats-temporada').value || seasonId;
            const { data: temp } = await supabase.from('seasons').select('name').eq('id', tempId).single();
            const { data: partidos } = await supabase.from('matches').select('*').eq('season_id', tempId).not('result', 'is', null);
            
            const victorias = partidos?.filter(p => p.result === 'win').length || 0;
            const empates = partidos?.filter(p => p.result === 'draw').length || 0;
            const derrotas = partidos?.filter(p => p.result === 'loss').length || 0;
            const gF = partidos?.reduce((sum, p) => sum + (p.team_goals || 0), 0) || 0;
            const gC = partidos?.reduce((sum, p) => sum + (p.opponent_goals || 0), 0) || 0;
            
            const { data: stats } = await supabase.from('match_player_stats').select('*, players(name, position), matches!inner(season_id)').eq('matches.season_id', tempId);
            
            const jugadorStats = {};
            (stats || []).forEach(s => {
                const pid = s.player_id;
                if (!jugadorStats[pid]) jugadorStats[pid] = { name: s.players?.name, pos: s.players?.position, pj: 0, min: 0, goles: 0, asist: 0, ta: 0, tr: 0 };
                if (s.minutes_played > 0) jugadorStats[pid].pj++;
                jugadorStats[pid].min += s.minutes_played || 0;
                jugadorStats[pid].goles += s.goals || 0;
                jugadorStats[pid].asist += s.assists || 0;
                jugadorStats[pid].ta += s.yellow_cards || 0;
                jugadorStats[pid].tr += s.red_cards || 0;
            });
            
            // Header
            doc.setFillColor(5, 150, 105);
            doc.rect(0, 0, 210, 45, 'F');
            doc.setTextColor(255);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('ESTADISTICAS DE TEMPORADA', 105, 20, { align: 'center' });
            doc.setFontSize(14);
            doc.text(`${clubData?.name || 'Mi Club'} - ${temp?.name || 'Temporada'}`, 105, 35, { align: 'center' });
            
            doc.setTextColor(30);
            doc.setFontSize(11);
            let y = 60;
            doc.setFont('helvetica', 'bold');
            doc.text('RESUMEN', 20, y);
            y += 10;
            doc.setFont('helvetica', 'normal');
            doc.text(`Partidos: ${partidos?.length || 0}  |  V: ${victorias}  |  E: ${empates}  |  D: ${derrotas}  |  GF: ${gF}  |  GC: ${gC}`, 20, y);
            
            y += 20;
            const ordenados = Object.values(jugadorStats).sort((a, b) => b.goles - a.goles);
            const tableData = ordenados.map(j => [j.name, j.pos, j.pj, j.min, j.goles, j.asist, j.ta, j.tr]);
            
            doc.autoTable({
                startY: y,
                head: [['Jugador', 'Pos', 'PJ', 'Min', 'Goles', 'Asist', 'TA', 'TR']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [5, 150, 105] },
                styles: { fontSize: 9 }
            });
            
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text('Generado con HUB TopLiderCoach', 105, 285, { align: 'center' });
            
            doc.save(`estadisticas_${temp?.name || 'temporada'}.pdf`);
        }
        
        // ========== MI CLUB: DATOS ==========
        async function cargarDatosClub() {
            if (!clubId) return;
            
            const { data } = await supabase.from('clubs').select('*').eq('id', clubId).single();
            clubData = data;
            
            document.getElementById('club-nombre').value = data.name || '';
            document.getElementById('club-pais').value = data.country || 'Espana';
            document.getElementById('club-formato').value = data.team_format || '11';
            
            if (data.logo_url) {
                document.getElementById('escudo-preview').src = data.logo_url;
                document.getElementById('escudo-preview').style.display = 'block';
                document.getElementById('escudo-placeholder').style.display = 'none';
            }
        }
        
        function previsualizarEscudo(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) { alert('Maximo 2MB'); return; }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('escudo-preview').src = e.target.result;
                document.getElementById('escudo-preview').style.display = 'block';
                document.getElementById('escudo-placeholder').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        
        async function guardarClub() {
            const nombre = document.getElementById('club-nombre').value.trim();
            if (!nombre) { alert('El nombre es obligatorio'); return; }
            
            let logoUrl = clubData?.logo_url;
            const escudoInput = document.getElementById('escudo-input');
            
            if (escudoInput.files.length > 0) {
                const file = escudoInput.files[0];
                const fileName = `club-${clubId}-${Date.now()}.${file.name.split('.').pop()}`;
                const { error: upErr } = await supabase.storage.from('logos').upload(fileName, file);
                if (!upErr) {
                    const { data: urlData } = supabase.storage.from('logos').getPublicUrl(fileName);
                    logoUrl = urlData.publicUrl;
                }
            }
            
            await supabase.from('clubs').update({
                name: nombre,
                country: document.getElementById('club-pais').value,
                team_format: document.getElementById('club-formato').value,
                logo_url: logoUrl
            }).eq('id', clubId);
            
            clubData.name = nombre;
            clubData.logo_url = logoUrl;
            
            // Actualizar header
            document.getElementById('club-nombre-header').textContent = nombre;
            if (logoUrl) {
                document.getElementById('club-badge').innerHTML = `<img src="${logoUrl}" alt=""><span>${nombre}</span>`;
            }
            
            alert('Club guardado');
        }
        
        // ========== MI CLUB: TEMPORADAS ==========
        async function cargarTemporadas() {
            const lista = document.getElementById('lista-temporadas');
            lista.innerHTML = '<div class="loading">Cargando...</div>';
            
            const { data } = await supabase.from('seasons').select('*').eq('club_id', clubId).order('start_date', { ascending: false });
            
            if (!data || data.length === 0) {
                lista.innerHTML = '<p style="text-align:center;color:#9ca3af;">No hay temporadas</p>';
                return;
            }
            
            lista.innerHTML = data.map(t => {
                const isActive = t.is_active;
                const fI = t.start_date ? new Date(t.start_date).toLocaleDateString('es-ES') : '';
                const fF = t.end_date ? new Date(t.end_date).toLocaleDateString('es-ES') : '';
                
                return `
                    <div class="temporada-card ${isActive ? 'active' : ''}">
                        <div class="temporada-info">
                            <h4>${t.name} ${isActive ? '<span class="temporada-badge">ACTIVA</span>' : ''}</h4>
                            <p>${fI} - ${fF}</p>
                        </div>
                        <div class="temporada-actions">
                            ${!isActive ? `<button class="btn-activar" onclick="activarTemporada('${t.id}')">Activar</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function crearTemporada() {
            const nombre = document.getElementById('nueva-temp-nombre').value.trim();
            if (!nombre) { alert('El nombre es obligatorio'); return; }
            
            await supabase.from('seasons').insert({
                club_id: clubId,
                name: nombre,
                start_date: document.getElementById('nueva-temp-inicio').value || null,
                end_date: document.getElementById('nueva-temp-fin').value || null,
                is_active: false
            });
            
            document.getElementById('nueva-temp-nombre').value = '';
            document.getElementById('nueva-temp-inicio').value = '';
            document.getElementById('nueva-temp-fin').value = '';
            
            alert('Temporada creada');
            cargarTemporadas();
        }
        
        async function activarTemporada(tempId) {
            if (!confirm('Activar esta temporada?')) return;
            
            await supabase.from('seasons').update({ is_active: false }).eq('club_id', clubId);
            await supabase.from('seasons').update({ is_active: true }).eq('id', tempId);
            
            seasonId = tempId;
            alert('Temporada activada');
            cargarTemporadas();
        }
        
        // ========== MI CLUB: PLANTILLA ==========
        async function cargarSelectorTemporadas() {
            const select = document.getElementById('plantilla-temporada');
            const { data } = await supabase.from('seasons').select('*').eq('club_id', clubId).order('start_date', { ascending: false });
            
            select.innerHTML = (data || []).map(t => {
                const selected = t.is_active ? 'selected' : '';
                return `<option value="${t.id}" ${selected}>${t.name} ${t.is_active ? '(activa)' : ''}</option>`;
            }).join('');
        }
        
     async function cargarPlantilla() {
            const tempId = document.getElementById('plantilla-temporada').value;
            if (!tempId) return;
            
            const lista = document.getElementById('lista-jugadores');
            lista.innerHTML = '<div class="loading">Cargando...</div>';
            
            try {
                const { data, error } = await supabase
                    .from('season_players')
                    .select('id, player_id, shirt_number, players(id, name, status, position, photo_url)')
                    .eq('season_id', tempId)
                    .order('shirt_number');
                
                if (error) throw error;
                
                const count = (data || []).length;
                
                const contador = document.getElementById('plantilla-contador');
                contador.textContent = `${count} / 30 jugadores`;
                contador.className = 'plantilla-contador';
                if (count >= 25) contador.classList.add('warning');
                if (count >= 30) contador.classList.add('full');
                
                let html = (data || []).map(sp => {
                    const j = sp.players || {};
                    const statusClass = j.status || 'available';
                    const statusText = { available: 'Disponible', injured: 'Lesionado', suspended: 'Sancionado' }[statusClass] || 'Disponible';
                    const inicial = j.name ? j.name.charAt(0).toUpperCase() : '?';

return `
    <div class="jugador-card">
        <div class="jugador-foto">
            ${j.photo_url 
                ? `<img src="${j.photo_url}" alt="${j.name}">` 
                : `<span>${inicial}</span>`
            }
        </div>
                            <div class="jugador-info">
                                <h4>${j.name || 'Sin nombre'}</h4>
                                <p>${j.position || ''}</p>
                                <span class="jugador-status ${statusClass}">${statusText}</span>
                            </div>
                            <div class="jugador-dorsal">${sp.shirt_number || '-'}</div>
                            <div class="jugador-actions">
                                <button class="btn-edit" onclick="editarJugador('${j.id}', '${sp.id}')">Editar</button>
                                <button class="btn-delete" onclick="eliminarJugadorDePlantilla('${sp.id}')">X</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (count < 30) {
                    html += `<div class="add-jugador-card" onclick="abrirModalJugador()"><div class="icon">+</div><span>Anadir Jugador</span></div>`;
                }
                
                lista.innerHTML = html;
                
            } catch (err) {
                console.error('Error cargando plantilla:', err);
                lista.innerHTML = '<p style="color:red;">Error al cargar jugadores</p>';
            }
        }
        
        function abrirModalJugador() {
            jugadorEditando = null;
            document.getElementById('modal-jugador-titulo').textContent = 'Nuevo Jugador';
            
            document.getElementById('jugador-id').value = '';
            document.getElementById('jugador-sp-id').value = '';
            document.getElementById('jugador-nombre').value = '';
            document.getElementById('jugador-dorsal').value = '';
            document.getElementById('jugador-posicion').value = '';
            document.getElementById('jugador-nacimiento').value = '';
            document.getElementById('jugador-pie').value = 'Derecho';
            document.getElementById('jugador-altura').value = '';
            document.getElementById('jugador-peso').value = '';
            document.getElementById('jugador-telefono').value = '';
            document.getElementById('jugador-email').value = '';
            document.getElementById('jugador-estado').value = 'available';
            
            document.getElementById('jugador-foto-preview').style.display = 'none';
            document.getElementById('jugador-foto-placeholder').style.display = 'flex';
            
            document.getElementById('modal-jugador').style.display = 'flex';
        }
        
        async function editarJugador(playerId, spId) {
            jugadorEditando = { playerId, spId };
            document.getElementById('modal-jugador-titulo').textContent = 'Editar Jugador';
            
            const { data: player } = await supabase.from('players').select('*').eq('id', playerId).single();
            const { data: sp } = await supabase.from('season_players').select('shirt_number').eq('id', spId).single();
            
            document.getElementById('jugador-id').value = playerId;
            document.getElementById('jugador-sp-id').value = spId;
            document.getElementById('jugador-nombre').value = player.name || '';
            document.getElementById('jugador-dorsal').value = sp?.shirt_number || '';
            document.getElementById('jugador-posicion').value = player.position || '';
            document.getElementById('jugador-nacimiento').value = player.birth_date || '';
            document.getElementById('jugador-pie').value = player.dominant_foot || 'Derecho';
            document.getElementById('jugador-altura').value = player.height_cm || '';
            document.getElementById('jugador-peso').value = player.weight_kg || '';
            document.getElementById('jugador-telefono').value = player.phone || '';
            document.getElementById('jugador-email').value = player.email || '';
            document.getElementById('jugador-estado').value = player.status || 'available';
            
            if (player.photo_url) {
                document.getElementById('jugador-foto-preview').src = player.photo_url;
                document.getElementById('jugador-foto-preview').style.display = 'block';
                document.getElementById('jugador-foto-placeholder').style.display = 'none';
            } else {
                document.getElementById('jugador-foto-preview').style.display = 'none';
                document.getElementById('jugador-foto-placeholder').style.display = 'flex';
            }
            
            document.getElementById('modal-jugador').style.display = 'flex';
        }
        
        function cerrarModalJugador(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modal-jugador').style.display = 'none';
            jugadorEditando = null;
        }
        
        function previsualizarFotoJugador(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('jugador-foto-preview').src = e.target.result;
                document.getElementById('jugador-foto-preview').style.display = 'block';
                document.getElementById('jugador-foto-placeholder').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        
        async function guardarJugador() {
            const nombre = document.getElementById('jugador-nombre').value.trim();
            const dorsal = document.getElementById('jugador-dorsal').value;
            const posicion = document.getElementById('jugador-posicion').value;
            
            if (!nombre || !dorsal || !posicion) {
                alert('Nombre, dorsal y posicion son obligatorios');
                return;
            }
            
            const tempId = document.getElementById('plantilla-temporada').value;
            
            let photoUrl = null;
            const fotoInput = document.getElementById('jugador-foto-input');
            if (fotoInput.files.length > 0) {
                const file = fotoInput.files[0];
                const fileName = `player-${Date.now()}.${file.name.split('.').pop()}`;
                const { error: upErr } = await supabase.storage.from('photos').upload(fileName, file);
                if (!upErr) {
                    const { data: urlData } = supabase.storage.from('photos').getPublicUrl(fileName);
                    photoUrl = urlData.publicUrl;
                }
            }
            
            const playerData = {
                club_id: clubId,
                name: nombre,
                position: posicion,
                birth_date: document.getElementById('jugador-nacimiento').value || null,
                dominant_foot: document.getElementById('jugador-pie').value,
                height_cm: document.getElementById('jugador-altura').value || null,
                weight_kg: document.getElementById('jugador-peso').value || null,
                phone: document.getElementById('jugador-telefono').value,
                email: document.getElementById('jugador-email').value,
                status: document.getElementById('jugador-estado').value
            };
            
            if (photoUrl) playerData.photo_url = photoUrl;
            
            if (jugadorEditando) {
                await supabase.from('players').update(playerData).eq('id', jugadorEditando.playerId);
                await supabase.from('season_players').update({ shirt_number: parseInt(dorsal) }).eq('id', jugadorEditando.spId);
            } else {
                const { data: newPlayer } = await supabase.from('players').insert(playerData).select().single();
                await supabase.from('season_players').insert({
                    season_id: tempId,
                    player_id: newPlayer.id,
                    shirt_number: parseInt(dorsal)
                });
            }
            
            cerrarModalJugador();
            cargarPlantilla();
            alert('Jugador guardado');
        }
        
        async function eliminarJugadorDePlantilla(spId) {
            if (!confirm('Eliminar este jugador de la plantilla?')) return;
            await supabase.from('season_players').delete().eq('id', spId);
            cargarPlantilla();
        }
 // ========== TU CUERPO TÉCNICO (IA) ==========
const GROQ_API_KEY = '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';

const staffConfig = {
    johan: {
        nombre: 'Johan',
        rol: 'Tu Planificador de Sesiones',
        color: '#f59e0b',
        emoji: '🧠',
        imagen: 'https://toplidercoach.com/wp-content/uploads/2025/12/captura-de-pantalla-2025-12-11-214833.png',
        systemPrompt: `Eres Johan, un experto planificador de sesiones de fútbol inspirado en la filosofía de Johan Cruyff.
Tu especialidad es diseñar sesiones de entrenamiento usando ejercicios REALES de la biblioteca de TopLiderCoach.

IMPORTANTE: Tienes acceso a una biblioteca de ejercicios reales. Cuando el usuario te pida una sesión:
1. Analiza los ejercicios disponibles que te proporciono en el contexto
2. Selecciona los más apropiados para el objetivo
3. Estructura la sesión en: Calentamiento, Parte Principal y Vuelta a la Calma
4. Indica el nombre EXACTO del ejercicio de la biblioteca, su duración y objetivo

Formato de respuesta para sesiones:
📋 NOMBRE DE LA SESIÓN
⏱️ Duración total: X min
🎯 Objetivo: [objetivo]
🏃 Jugadores: X

CALENTAMIENTO (X min):
1. [Nombre ejercicio de la biblioteca] - X min
   Objetivo: [descripción]

PARTE PRINCIPAL (X min):
2. [Nombre ejercicio de la biblioteca] - X min
   Objetivo: [descripción]
...

VUELTA A LA CALMA (X min):
...

Si no encuentras ejercicios apropiados en la biblioteca, sugiere ejercicios genéricos pero indica que no están en la biblioteca.
Responde siempre en español y sé cercano pero profesional.`
    },
    valeri: {
        nombre: 'Valeri',
        rol: 'Tu Analista de Rendimiento',
        color: '#3b82f6',
        emoji: '📊',
        imagen: 'https://toplidercoach.com/wp-content/uploads/2025/12/captura-de-pantalla-2025-12-11-214736.png',
        systemPrompt: `Eres Valeri, un analista de rendimiento deportivo inspirado en Valeriy Lobanovskyi.
Tu especialidad es analizar estadísticas REALES de los jugadores del equipo.

IMPORTANTE: Tienes acceso a las estadísticas reales del equipo:
- Partidos jugados, resultados, goles
- Estadísticas individuales: minutos, goles, asistencias, tarjetas
- Puedes comparar jugadores entre sí
- Puedes detectar tendencias y patrones

Cuando analices datos:
1. Usa SOLO los datos reales que te proporciono
2. Sé objetivo y preciso con los números
3. Compara con promedios del equipo
4. Identifica fortalezas y áreas de mejora
5. Sugiere acciones concretas basadas en los datos

Formato de análisis:
📊 ANÁLISIS: [título]
📈 Datos clave:
- [dato 1]
- [dato 2]
...
💡 Conclusiones:
- [conclusión 1]
- [conclusión 2]
✅ Recomendaciones:
- [recomendación 1]
...

Si te preguntan por algo que no está en los datos, indícalo claramente.
Responde siempre en español.`
    },
    arrigo: {
        nombre: 'Arrigo',
        rol: 'Tu Entrenador Táctico',
        color: '#10b981',
        emoji: '⚽',
        imagen: 'https://toplidercoach.com/wp-content/uploads/2025/12/captura-de-pantalla-2025-12-11-214756.png',
        systemPrompt: `Eres Arrigo, un maestro de la táctica futbolística inspirado en Arrigo Sacchi.
Tu especialidad es recomendar ejercicios TÁCTICOS de la biblioteca de TopLiderCoach.

IMPORTANTE: Tienes acceso a ejercicios reales filtrados por TEMA TÁCTICO.
Cuando el usuario pregunte sobre táctica:
1. Explica el concepto táctico claramente
2. Recomienda ejercicios REALES de la biblioteca relacionados con ese tema
3. Indica el nombre exacto del ejercicio
4. Explica cómo aplicarlo

Temas tácticos que dominas:
- Pressing alto y pressing tras pérdida
- Transiciones ofensivas y defensivas
- Juego de posición y posesión
- Movimientos sin balón
- Desmarques y combinaciones
- Sistemas de juego (4-3-3, 4-4-2, 3-5-2, etc.)
- Jugadas a balón parado
- Defensa en zona vs individual

Formato de respuesta:
⚽ CONCEPTO TÁCTICO: [nombre]
📖 Explicación:
[explicación clara del concepto]

🏋️ EJERCICIOS RECOMENDADOS:
1. [Nombre ejercicio de la biblioteca]
   - Tema: [tema]
   - Cómo aplicarlo: [descripción]
2. ...

💡 Consejos de aplicación:
- [consejo 1]
- [consejo 2]

Responde siempre en español con pasión por la táctica.`
    }
};

let currentStaff = null;
let chatHistory = [];

// ========== FUNCIONES DE CONTEXTO PARA IA ==========

// Obtener datos del club y plantilla
async function obtenerContextoClub() {
    try {
        const { data: jugadores } = await supabase
            .from('season_players')
            .select('id, shirt_number, players(id, name, position)')
            .eq('season_id', seasonId)
            .order('shirt_number');
        
        return {
            clubNombre: clubData?.name || 'Mi Club',
            jugadores: (jugadores || []).map(sp => ({
                id: sp.players?.id,
                nombre: sp.players?.name,
                dorsal: sp.shirt_number,
                posicion: sp.players?.position
            }))
        };
    } catch (e) {
        console.error('Error obteniendo contexto club:', e);
        return { clubNombre: 'Mi Club', jugadores: [] };
    }
}

// Obtener estadísticas para Valeri
async function obtenerContextoEstadisticas() {
    try {
        // Partidos de la temporada
        const { data: partidos } = await supabase
            .from('matches')
            .select('*')
            .eq('season_id', seasonId)
            .order('match_date', { ascending: false });
        
        // Estadísticas de jugadores
        const { data: stats } = await supabase
            .from('match_player_stats')
            .select('*, players(id, name, position), matches!inner(id, opponent, match_date, result, team_goals, opponent_goals, season_id)')
            .eq('matches.season_id', seasonId);
        
        // Agrupar stats por jugador
        const jugadorStats = {};
        (stats || []).forEach(s => {
            const pid = s.player_id;
            if (!jugadorStats[pid]) {
                jugadorStats[pid] = {
                    nombre: s.players?.name,
                    posicion: s.players?.position,
                    partidos: 0,
                    minutos: 0,
                    goles: 0,
                    asistencias: 0,
                    amarillas: 0,
                    rojas: 0
                };
            }
            if (s.minutes_played > 0) jugadorStats[pid].partidos++;
            jugadorStats[pid].minutos += s.minutes_played || 0;
            jugadorStats[pid].goles += s.goals || 0;
            jugadorStats[pid].asistencias += s.assists || 0;
            jugadorStats[pid].amarillas += s.yellow_cards || 0;
            jugadorStats[pid].rojas += s.red_cards || 0;
        });
        
        // Resumen de partidos
        const victorias = partidos?.filter(p => p.result === 'win').length || 0;
        const empates = partidos?.filter(p => p.result === 'draw').length || 0;
        const derrotas = partidos?.filter(p => p.result === 'loss').length || 0;
        const golesFavor = partidos?.reduce((sum, p) => sum + (p.team_goals || 0), 0) || 0;
        const golesContra = partidos?.reduce((sum, p) => sum + (p.opponent_goals || 0), 0) || 0;
        
        return {
            totalPartidos: partidos?.length || 0,
            partidosJugados: partidos?.filter(p => p.result).length || 0,
            victorias,
            empates,
            derrotas,
            golesFavor,
            golesContra,
            estadisticasJugadores: Object.values(jugadorStats).sort((a, b) => b.goles - a.goles),
            ultimosPartidos: (partidos || []).slice(0, 5).map(p => ({
                rival: p.opponent,
                fecha: p.match_date,
                resultado: p.result,
                marcador: `${p.team_goals || 0}-${p.opponent_goals || 0}`
            }))
        };
    } catch (e) {
        console.error('Error obteniendo estadísticas:', e);
        return null;
    }
}

// Obtener ejercicios de la API para Johan
async function obtenerEjerciciosPorTema(tema = '', limite = 15) {
    try {
        let url = `${API_BASE}/ejercicios?per_page=${limite}`;
        if (tema) url += `&tema=${encodeURIComponent(tema)}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        return (data.ejercicios || []).map(ej => ({
            id: ej.id,
            titulo: ej.titulo,
            tema: ej.tema,
            dificultad: ej.dificultad,
            duracion: ej.duracion || 10,
            imagen: ej.imagen
        }));
    } catch (e) {
        console.error('Error obteniendo ejercicios:', e);
        return [];
    }
}

// Obtener temas disponibles
async function obtenerTemasDisponibles() {
    try {
        const response = await fetch(`${API_BASE}/filtros`);
        const data = await response.json();
        return data.filtros?.temas || [];
    } catch (e) {
        console.error('Error obteniendo temas:', e);
        return [];
    }
}

// Obtener sesiones recientes para Johan
async function obtenerContextoSesiones() {
    try {
        const { data: sesiones } = await supabase
            .from('training_sessions')
            .select('id, name, session_date, objective, warm_up, main_part, cool_down')
            .eq('club_id', clubId)
            .order('session_date', { ascending: false })
            .limit(10);
        
        return {
            totalSesiones: sesiones?.length || 0,
            ultimasSesiones: (sesiones || []).map(s => ({
                nombre: s.name,
                fecha: s.session_date,
                objetivo: s.objective,
                duracion: (s.warm_up?.length || 0) + (s.main_part?.length || 0) + (s.cool_down?.length || 0),
                fase: s.objective ? 'completa' : 'sin objetivo'
            }))
        };
    } catch (e) {
        console.error('Error obteniendo sesiones:', e);
        return { totalSesiones: 0, ultimasSesiones: [] };
    }
}

// Generar contexto según el asistente
function generarContextoParaIA(staff, contextoClub, contextoStats, contextoSesiones, ejercicios, temas) {
    let contexto = `\n\n--- DATOS DEL EQUIPO ---\n`;
    contexto += `Club: ${contextoClub.clubNombre}\n`;
    contexto += `Plantilla (${contextoClub.jugadores.length} jugadores):\n`;
    contextoClub.jugadores.forEach(j => {
        contexto += `- #${j.dorsal} ${j.nombre} (${j.posicion})\n`;
    });
    
    if (staff === 'valeri' && contextoStats) {
        contexto += `\n--- ESTADÍSTICAS DE TEMPORADA ---\n`;
        contexto += `Partidos jugados: ${contextoStats.partidosJugados}\n`;
        contexto += `Victorias: ${contextoStats.victorias} | Empates: ${contextoStats.empates} | Derrotas: ${contextoStats.derrotas}\n`;
        contexto += `Goles a favor: ${contextoStats.golesFavor} | Goles en contra: ${contextoStats.golesContra}\n`;
        
        if (contextoStats.ultimosPartidos.length > 0) {
            contexto += `\nÚltimos partidos:\n`;
            contextoStats.ultimosPartidos.forEach(p => {
                const res = p.resultado === 'win' ? '✅' : p.resultado === 'draw' ? '🟡' : '❌';
                contexto += `${res} vs ${p.rival}: ${p.marcador}\n`;
            });
        }
        
        if (contextoStats.estadisticasJugadores.length > 0) {
            contexto += `\nEstadísticas por jugador:\n`;
            contextoStats.estadisticasJugadores.forEach(j => {
                contexto += `- ${j.nombre} (${j.posicion}): ${j.partidos} PJ, ${j.minutos} min, ${j.goles} goles, ${j.asistencias} asist, ${j.amarillas} TA, ${j.rojas} TR\n`;
            });
        }
    }
    
    if (staff === 'johan') {
        if (contextoSesiones && contextoSesiones.ultimasSesiones.length > 0) {
            contexto += `\n--- SESIONES RECIENTES ---\n`;
            contextoSesiones.ultimasSesiones.forEach(s => {
                contexto += `- ${s.fecha}: "${s.nombre}" - Objetivo: ${s.objetivo || 'No definido'}\n`;
            });
        }
        
        if (ejercicios && ejercicios.length > 0) {
            contexto += `\n--- EJERCICIOS DISPONIBLES EN LA BIBLIOTECA ---\n`;
            ejercicios.forEach(ej => {
                contexto += `- "${ej.titulo}" | Tema: ${ej.tema || 'General'} | Duración: ${ej.duracion} min | Dificultad: ${ej.dificultad || '?'}\n`;
            });
        }
        
        if (temas && temas.length > 0) {
            contexto += `\nTemas disponibles para filtrar: ${temas.join(', ')}\n`;
        }
    }
    
    if (staff === 'arrigo') {
        if (temas && temas.length > 0) {
            contexto += `\n--- TEMAS DE ENTRENAMIENTO DISPONIBLES ---\n`;
            contexto += temas.join(', ') + '\n';
        }
        
        if (ejercicios && ejercicios.length > 0) {
            contexto += `\n--- EJERCICIOS TÁCTICOS DISPONIBLES ---\n`;
            ejercicios.forEach(ej => {
                contexto += `- "${ej.titulo}" | Tema: ${ej.tema || 'General'} | Duración: ${ej.duracion} min\n`;
            });
        }
    }
    
    return contexto;
}

// ========== FUNCIONES DEL CHAT ==========

async function abrirChatStaff(staffId) {
    currentStaff = staffId;
    const staff = staffConfig[staffId];
    
    // Configurar modal
    document.getElementById('chat-nombre').textContent = staff.nombre;
    document.getElementById('chat-rol').textContent = staff.rol;
    document.getElementById('chat-avatar').innerHTML = `<img src="${staff.imagen}" alt="${staff.nombre}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
    document.getElementById('chat-avatar').style.background = `linear-gradient(135deg, ${staff.color} 0%, ${staff.color}dd 100%)`;
    document.getElementById('chat-header').style.background = `linear-gradient(135deg, ${staff.color} 0%, ${staff.color}dd 100%)`;
    document.getElementById('chat-header').style.color = 'white';
    
    // Limpiar chat
    chatHistory = [];
    const messagesDiv = document.getElementById('chat-messages');
    messagesDiv.innerHTML = `
        <div class="chat-message assistant">
            <div class="avatar" style="background: linear-gradient(135deg, ${staff.color} 0%, ${staff.color}dd 100%);"><img src="${staff.imagen}" alt="${staff.nombre}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"></div>
            <div class="contenido">
                <em>Cargando datos del equipo...</em>
            </div>
        </div>
    `;
    
    document.getElementById('modal-chat-staff').style.display = 'flex';
    
    // Cargar contexto según el asistente
    try {
        const contextoClub = await obtenerContextoClub();
        let contextoStats = null;
        let contextoSesiones = null;
        let ejercicios = [];
        let temas = [];
        
        if (staffId === 'valeri') {
            contextoStats = await obtenerContextoEstadisticas();
        }
        
        if (staffId === 'johan') {
            contextoSesiones = await obtenerContextoSesiones();
            ejercicios = await obtenerEjerciciosPorTema('', 20);
            temas = await obtenerTemasDisponibles();
        }
        
        if (staffId === 'arrigo') {
            temas = await obtenerTemasDisponibles();
            // Cargar ejercicios de varios temas tácticos
            ejercicios = await obtenerEjerciciosPorTema('', 25);
        }
        
        // Guardar contexto para usarlo en las consultas
        window.currentStaffContext = generarContextoParaIA(staffId, contextoClub, contextoStats, contextoSesiones, ejercicios, temas);
        
        // Mensaje de bienvenida personalizado
     // DESPUÉS (más natural):
let saludoExtra = '';
if (staffId === 'valeri' && contextoStats) {
    saludoExtra = `Ya he revisado las estadísticas de la temporada.`;
} else if (staffId === 'johan') {
    saludoExtra = `Estoy listo para diseñar tu próxima sesión.`;
} else if (staffId === 'arrigo') {
    saludoExtra = `¿Qué aspecto táctico quieres trabajar?`;
}
        
        messagesDiv.innerHTML = `
            <div class="chat-message assistant">
                <div class="avatar" style="background: linear-gradient(135deg, ${staff.color} 0%, ${staff.color}dd 100%);"><img src="${staff.imagen}" alt="${staff.nombre}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"></div>
                <div class="contenido">
                    ¡Hola! Soy <strong>${staff.nombre}</strong>, ${staff.rol.toLowerCase()}. 
                    ${contextoClub.jugadores.length > 0 
                        ? `Veo que tienes ${contextoClub.jugadores.length} jugadores en la plantilla de ${contextoClub.clubNombre}.` 
                        : 'No veo jugadores en tu plantilla actual.'}
                    ${saludoExtra}
                    <br><br>¿En qué puedo ayudarte?
                </div>
            </div>
        `;
        
    } catch (e) {
        console.error('Error cargando contexto:', e);
        messagesDiv.innerHTML = `
            <div class="chat-message assistant">
                <div class="avatar" style="background: linear-gradient(135deg, ${staff.color} 0%, ${staff.color}dd 100%);"><img src="${staff.imagen}" alt="${staff.nombre}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"></div>
                <div class="contenido">
                    ¡Hola! Soy <strong>${staff.nombre}</strong>. No he podido cargar todos los datos del equipo, pero puedo ayudarte con consultas generales. ¿En qué puedo ayudarte?
                </div>
            </div>
        `;
    }
    
    document.getElementById('chat-input').value = '';
    document.getElementById('chat-input').focus();
}

function cerrarChatStaff(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('modal-chat-staff').style.display = 'none';
    currentStaff = null;
    chatHistory = [];
    window.currentStaffContext = null;
}

async function enviarMensajeChat() {
    const input = document.getElementById('chat-input');
    const mensaje = input.value.trim();
    
    if (!mensaje || !currentStaff) return;
    
    const staff = staffConfig[currentStaff];
    const messagesDiv = document.getElementById('chat-messages');
    
    // Añadir mensaje del usuario
    messagesDiv.innerHTML += `
        <div class="chat-message user">
            <div class="avatar">👤</div>
            <div class="contenido">${mensaje}</div>
        </div>
    `;
    
    input.value = '';
    
    // Mostrar indicador de escritura
    const typingId = 'typing-' + Date.now();
    messagesDiv.innerHTML += `
        <div class="chat-typing" id="${typingId}">
            <div class="avatar" style="background: linear-gradient(135deg, ${staff.color} 0%, ${staff.color}dd 100%); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;"><img src="${staff.imagen}" alt="${staff.nombre}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"></div>
            <span>${staff.nombre} está escribiendo...</span>
            <div class="dots"><span></span><span></span></div>
        </div>
    `;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    // Añadir a historial
    chatHistory.push({ role: 'user', content: mensaje });
    
    try {
        // ========== BÚSQUEDA DINÁMICA DE EJERCICIOS ==========
        if (currentStaff === 'johan' || currentStaff === 'arrigo') {
            
            // Obtener temas disponibles
            const temasDisponibles = await obtenerTemasDisponibles();
            
            // Detectar si el usuario menciona algún tema
            const mensajeLower = mensaje.toLowerCase();
            let temasEncontrados = temasDisponibles.filter(tema => 
                mensajeLower.includes(tema.toLowerCase())
            );
            
            // Palabras clave comunes que mapean a temas
            const mapeoTemas = {
                'pressing': ['pressing', 'presion', 'presionar'],
                'posesion': ['posesion', 'posesión', 'tener el balon', 'mantener'],
                'transicion': ['transicion', 'transición', 'contragolpe', 'contra'],
                'finalizacion': ['finalizacion', 'finalización', 'remate', 'gol', 'disparar'],
                'defensa': ['defensa', 'defender', 'defensivo'],
                'ataque': ['ataque', 'atacar', 'ofensivo'],
                'rondo': ['rondo', 'rondos'],
                'calentamiento': ['calentamiento', 'calentar', 'activacion'],
                'fisico': ['fisico', 'físico', 'resistencia', 'fuerza', 'velocidad'],
                'tactica': ['tactica', 'táctica', 'tactico', 'táctico', 'sistema'],
                'tecnica': ['tecnica', 'técnica', 'control', 'pase', 'conduccion']
            };
            
            // Buscar en el mapeo
            for (const [tema, keywords] of Object.entries(mapeoTemas)) {
                if (keywords.some(kw => mensajeLower.includes(kw))) {
                    // Buscar el tema real que coincida
                    const temaReal = temasDisponibles.find(t => 
                        t.toLowerCase().includes(tema) || tema.includes(t.toLowerCase())
                    );
                    if (temaReal && !temasEncontrados.includes(temaReal)) {
                        temasEncontrados.push(temaReal);
                    }
                }
            }
            
            // Buscar ejercicios de los temas encontrados
            let ejerciciosRelevantes = [];
            
            if (temasEncontrados.length > 0) {
                // Buscar por cada tema encontrado
                for (const tema of temasEncontrados.slice(0, 3)) { // Máximo 3 temas
                    const ejerciciosTema = await obtenerEjerciciosPorTema(tema, 15);
                    ejerciciosRelevantes = ejerciciosRelevantes.concat(ejerciciosTema);
                }
            } else {
                // Si no hay tema, buscar por palabras clave en el título
                const palabrasBusqueda = mensajeLower
                    .split(' ')
                    .filter(p => p.length > 3 && !['para', 'como', 'quiero', 'dame', 'necesito', 'crear', 'hacer'].includes(p));
                
                if (palabrasBusqueda.length > 0) {
                    // Buscar por la primera palabra clave relevante
                    const response = await fetch(`${API_BASE}/ejercicios?search=${encodeURIComponent(palabrasBusqueda[0])}&per_page=20`);
                    const data = await response.json();
                    ejerciciosRelevantes = (data.ejercicios || []).map(ej => ({
                        id: ej.id,
                        titulo: ej.titulo,
                        tema: ej.tema,
                        dificultad: ej.dificultad,
                        duracion: ej.duracion || 10
                    }));
                }
                
                // Si aún no hay ejercicios, cargar algunos generales
                if (ejerciciosRelevantes.length === 0) {
                    ejerciciosRelevantes = await obtenerEjerciciosPorTema('', 20);
                }
            }
            
            // Eliminar duplicados
            const ejerciciosUnicos = [];
            const idsVistos = new Set();
            for (const ej of ejerciciosRelevantes) {
                if (!idsVistos.has(ej.id)) {
                    idsVistos.add(ej.id);
                    ejerciciosUnicos.push(ej);
                }
            }
            
            // Actualizar contexto con ejercicios encontrados
            if (ejerciciosUnicos.length > 0) {
                let contextoEjercicios = `\n\n--- EJERCICIOS ENCONTRADOS PARA TU CONSULTA ---\n`;
                // DESPUÉS:
contextoEjercicios += `\n`;
                
                ejerciciosUnicos.forEach((ej, idx) => {
                    contextoEjercicios += `${idx + 1}. "${ej.titulo}"\n`;
                    contextoEjercicios += `   - Tema: ${ej.tema || 'General'}\n`;
                    contextoEjercicios += `   - Duración: ${ej.duracion} min\n`;
                    contextoEjercicios += `   - Dificultad: ${ej.dificultad || 'No especificada'}\n\n`;
                });
                
                window.currentStaffContext = (window.currentStaffContext || '') + contextoEjercicios;
            }
        }
        
        // Construir prompt con contexto
        const promptConContexto = staff.systemPrompt + (window.currentStaffContext || '');
        
        const respuesta = await llamarGroq(promptConContexto, chatHistory);
        
        // Quitar indicador de escritura
        document.getElementById(typingId)?.remove();
        
        // Añadir respuesta
        chatHistory.push({ role: 'assistant', content: respuesta });
        
        messagesDiv.innerHTML += `
            <div class="chat-message assistant">
                <div class="avatar" style="background: linear-gradient(135deg, ${staff.color} 0%, ${staff.color}dd 100%);"><img src="${staff.imagen}" alt="${staff.nombre}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"></div>
                <div class="contenido">${formatearRespuesta(respuesta)}</div>
            </div>
        `;
        
    } catch (error) {
        document.getElementById(typingId)?.remove();
        messagesDiv.innerHTML += `
            <div class="chat-message assistant">
                <div class="avatar" style="background: #ef4444;">⚠️</div>
                <div class="contenido" style="color: #dc2626;">Lo siento, ha ocurrido un error. Inténtalo de nuevo.</div>
            </div>
        `;
        console.error('Error Groq:', error);
    }
    
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
async function llamarGroq(systemPrompt, messages) {
    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${GROQ_API_KEY}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            model: 'llama-3.3-70b-versatile',
            messages: [
                { role: 'system', content: systemPrompt },
                ...messages
            ],
            temperature: 0.7,
            max_tokens: 2500
        })
    });
    
    if (!response.ok) {
        throw new Error('Error en la API de Groq');
    }
    
    const data = await response.json();
    return data.choices[0].message.content;
}

function formatearRespuesta(texto) {
    return texto
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/^/, '<p>')
        .replace(/$/, '</p>');
}
        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('hub_user');
            const savedToken = localStorage.getItem('hub_token');
            
            if (savedUser && savedToken) {
                usuario = JSON.parse(savedUser);
                token = savedToken;
                mostrarApp();
            }
            
            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });
            
            // Inicializar sesión
            renderizarSesion();
        });
    </script>
</body>
</html>
